%! TeX program = xelatex
%! lang = en-US
\subsection{The Corrected Theorem}
\label{sec:proof}

\AP
The counter example provided by \cref{def:bad-polynomial} relies on the fact
that $\CoveredPoly$ is not stable under fixing indeterminates, while
\kl{$\Nat$-polyregular functions} are. In this section, we prove that closing
$\CorrectPoly$ under assignments of variable is enough to recover from
\cref{karh:thm}.
We use the following notation to fix the value of some indeterminate, if
$P(X,Y)$ is a polynomial in $\Rel[X,Y]$, then $\intro*\restr{P(X,Y)}{X = 1}$ is
the polynomial $P(1,Y) \in \Rel[Y]$. More generally, if $\nu$ is a partial
function from $\vec{X}$ to $\Nat$, written $\nu \colon \vec{X} \topartial
\Nat$, the restriction $\restr{P(\vec{X})}{\nu}$ is the polynomial with
indeterminates $\vec{Y} \defined \vec{X} - \dom(\nu)$ obtained by fixing the
variables of the domain of $\nu$.


\begin{definition}
    Let $\vec{X}$ be a finite tuple of indeterminates.
    The class $\intro*\CorrectPoly[\vec{X}]$ is the collection of
    polynomials $P \in \Rel[\vec{X}]$ such that
    $P$ is 
    such that, for every partial function $\nu \colon \vec{X} \topartial \Nat$,
    every \kl{maximal monomial} of
    $\restr{P}{\nu}$ is \kl{non-negative}.
\end{definition}

First, let us remark that $\CorrectPoly \subseteq \CoveredPoly$, because
polynomials in $\CorrectPoly$ are \kl{non-negative}. Let us also check that the
counter example provided in \cref{thm:counter-example} is not in
$\CorrectPoly$. For that, notice that for $\BadPoly$ introduced in
\cref{def:bad-polynomial}, $\BadPoly(X,Y,1) = 3X^2 + 3Y^2 - 2XY$, which has a negative
coefficient for a \kl{maximal monomial}, namely $-2XY$. 

Let us now prove that \kl{$\Nat$-rational polynomials} are in $\CorrectPoly$.
This follows from the correct implication in the statement of \cref{karh:thm},
but we provide a self-contained proof using a refinement of the classical
combinatorial arguments for $\ZPoly$ \cite[Lemma 4.16]{CDTL23} and $\NPoly$
\cite[Lemma 5.37]{DOUE23}. The proof is based on a combinatorial
characterization of $\NPoly$ reminiscent of the \emph{finite counting automata}
introduced by \cite{SCHU62}.

\begin{lemma}
    \label{n-poly-combinatorics:lem}
    Let $f$ be an \kl{$\Nat$-polyregular} function. 
    There exists a computable $\omega \in \Nat$
    such that for all $p \in \Nat$,
    for all $\alpha_0, \dots, \alpha_p \in \Sigma^*$,
    for all $u_1, \dots, u_p \in \Sigma^*$,
    there exists a polynomial $P \in \Rel[X_1, \dots, X_p]$
    whose \kl{maximal monomials} are \kl{non-negative},
    and such that for all $X_1, \dots, X_p \geq \omega$:
    \begin{equation*}
        f\left(
            \alpha_0 \prod_{i = 1}^p u_i^{\omega X_i} \alpha_i
        \right)
        = P(X_1, \dots, X_p) \quad .
    \end{equation*}
    \proofref{n-poly-combinatorics:lem}
\end{lemma}


\begin{corollary}
    \label{n-rat-correct:lem}
    Let $P \in \Rel[X_1, \dots, X_p]$ be an \kl{$\Nat$-rational polynomial}.
    Then,
    $P \in \CorrectPoly$.
    \proofref{n-rat-correct:lem}
\end{corollary}

\AP The core of the upcoming \cref{lem:correct-to-n-rat} leverages a notion of
\intro{discrete derivative} to perform an induction on the \kl{maximal monomials}.
This notion of derivation is built by translating the domain of the polynomial.
To that end, let us write $\intro*\translate{K}$ for the \intro{translation function}
that maps a polynomial $P \in \Rel[X_1, \dots, X_n]$ to the polynomial $P(X_1 +
K, \dots, X_n + K)$.

\begin{definition}
    \label{discrete-derivative:def}
    Let
    $K \in \Nat$,
    and 
    $P \in \Rel[\vec{X}]$ be a polynomial,
    then 
    %\begin{equation*}
    $
        \intro*\Diff{K}{P} \defined 
        \translate{K}(P) - P
    $.
    %    \quad .
    %\end{equation*}
\end{definition}

\AP The key lemma of this section is \cref{lem:correct-to-n-rat}, which is
proved by induction on the \kl{maximal monomials} of a polynomial $P$. The core
combinatorial argument allowing to perform the induction is
\cref{derivation-stabilises-correct:lem}, which is proved by a straightforward
binomial expansion. Using this lemma, the induction is performed as follows:
after decomposing a polynomial $P$ into a sum of \kl{maximal monomials} $P_1$
and the rest $P_2$, notice that for all $K \in \Nat$, $\translate{K}(P) = P_1 +
\Diff{K}{P_1} + \translate{K}(P_2)$. Then, because $P \in \CorrectPoly$, $P_1$
is a \kl{$\Nat$-rational polynomial}, furthermore, we can use the induction
hypothesis on $\Diff{K}{P_1} + \translate{k}(P_2)$ since it has lower degree
monomials and is in $\CorrectPoly$, finally we can also apply the induction
hypothesis to $\restr{P}{\nu}$ where $\nu$ is a partial function from $\vec{X}$
to $\set{0, \dots, K}$ fixing at least one variable. It is then just a matter
of combining these functions to obtain a \kl{$\Nat$-polyregular function} that
\kl{represents} $P$. Notice that in \cref{lem:correct-to-n-rat}, polynomials
can be represented using \kl{star-free $\Nat$-polyregular functions}, which is
a stronger statement than the one in \cref{karh:thm}, but is in line with the
idea that polynomials are not periodic functions (for instance, in
\cref{zsf-nsf:conjecture}).

\begin{lemma}
    \label{derivation-stabilises-correct:lem}
    Let $P \in \CorrectPoly$,
    $P_1$ be the sum of \kl{maximal monomials} of $P$,
    and $P_2 \defined P - P_1$ be the sum of
    non-maximal monomials of $P$.
    There exists a computable $K$,
    such that
    $Q \defined (\Diff{K}{P_1} + \translate{K}(P_2)) \in \CorrectPoly$.
    \proofref{derivation-stabilises-correct:lem}
\end{lemma}


\begin{lemma}
    \label{lem:correct-to-n-rat}
    Let $\vec{X}$ be a tuple of indeterminates,
    and let $P \in \Rel[\vec{X}]$.
    If $P \in \CorrectPoly$, then $P$ is \kl{represented}
    by a \kl{star-free $\Nat$-polyregular function},
    which is computable given $P$.
    \proofref{lem:correct-to-n-rat}
\end{lemma}


While \cref{lem:correct-to-n-rat} provides effective conversion, it does not
explicitly state that the membership is decidable to keep the proof clearer. A
similar proof scheme can be followed to conclude that membership is decidable,
and even show that elements in $\CorrectPoly$ are, up to suitable translations,
polynomials in $\Nat[\vec{X}]$. Beware that partial applications are still
needed in this characterization, as \cref{bad-poly-translate:ex} illustrates.
Effectiveness was the last missing piece of our main result
\cref{corrected-version:thm}, which corrects and generalizes \cref{karh:thm}.

\begin{lemma}
    \label{derivation-translation:lem}
    Let $P \in \Rel[\vec{X}]$, 
    there exists a computable $K \in \Nat$
    such that the following are equivalent:
    \begin{enumerate}
        \item \label{d-t-correct:item} $P \in \CorrectPoly$,
        \item \label{d-t-transl:item}
            for 
            all partial functions $\nu \colon \vec{X} \topartial \Nat$,
            $\translate{K}(\restr{P}{\nu}) \in \Nat[\vec{X}]$,
        \item \label{d-t-transl-fin:item}
            for all partial functions
            $\nu \colon \vec{X} \topartial \set{0, \dots, K}$,
            $\translate{K}(\restr{P}{\nu}) \in \Nat[\vec{X}]$.
    \end{enumerate}
    Furthermore, the membership is decidable.
    \proofref{derivation-translation:lem}
\end{lemma}

\begin{example}
    \label{bad-poly-translate:ex}
    The polynomial $\BadPoly$ is not a 
    \kl{$\Nat$-rational polynomial},
    but is \kl{non-negative} and satisfies
    $\translate{10}(\BadPoly) \in \Nat[\vec{X}]$.
\end{example}


\begin{theorem}
    \label{corrected-version:thm}
    Let $P \in \Rel[\vec{X}]$ be a polynomial.
    The following are equivalent:
    \begin{enumerate}
        \item \label{corrected-1:item} $P \in \CorrectPoly$,
        \item \label{corrected-2:item} $P$ is \kl{represented} by a \kl{$\Nat$-rational series},
        \item \label{corrected-3:item} $P$ is \kl{represented} by a \kl{$\Nat$-polyregular function},
        \item \label{corrected-4:item} $P$ is \kl{represented} by a \kl{star-free $\Nat$-polyregular function},
    \end{enumerate}
    Furthermore, the properties are decidable, and conversions effective.
\end{theorem}

For completeness, let us remark that the counter example of
\cref{thm:counter-example} uses three indeterminates, and this is not a
coincidence: in the particular case of at most two indeterminates, the classes
$\CorrectPoly$ and $\CoveredPoly$ coincide. In particular, the examples
appearing in \cite{KARH77} are not invalidated, as they all use at most two
indeterminates. This is because, in the univariate case, being non-negative and
having non-negative maximal coefficient implies being an \kl{$\Nat$-rational
polynomial}.

\begin{lemma}
    \label{lem:correct-covered-2}
    $\CorrectPoly[X,Y] = \CoveredPoly[X,Y]$.
    \proofref{lem:correct-covered-2}
\end{lemma}

