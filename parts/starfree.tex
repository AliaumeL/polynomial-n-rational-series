%! TeX program = xelatex
%! lang = en-US
\section{Beyond Polynomials}
\label{beyond-polynomials:sec}
\label{star-free:sec}

In this section, we leverage the decidability results of \cref{polynomials:sec}
to decide membership in $\NPoly$
inside $\ZPoly$ and membership in $\NSF$ inside $\NPoly$, both under the extra
assumption of \kl{commutativity}. 

%\subsection{Deciding $\NPoly$ inside $\ZPoly$}

To characterize $\NPoly$ inside $\ZPoly$ we introduce the notion of
\kl{$(k,\Nat)$-combinatorial} function
(\cref{k-combinatorial:def}), following the spirit of previous
characterizations of subclasses of $\ZPoly$ in terms of \emph{polynomial
pumping arguments} \cite{DOUE21,DOUE22,CDTL23}.

\begin{definition}
    \label{k-combinatorial:def}
    Let $k \in \Nat$, and $f \colon \Sigma^* \to \Rel$
    be a \kl{$\Rel$-polyregular function}. The function $f$ is 
    \intro{$(k,\Nat)$-combinatorial} if there exists $\omega \in \Nat$,
    such that
    for all
    \kl{pumping patterns} $q \colon \Nat^k \to \Sigma^*$,
    there exists a \kl{strongly natural binomial polynomial} $P$
    satisfying:
    \begin{equation*}
        f \circ q(\omega X_1,\dots, \omega X_k)
        = 
        P
        \quad 
        \text{ over } (\Nat_{\geq 1})^k
        \quad .
    \end{equation*}
\end{definition}

\AP
\Cref{k-combinatorial:def} is meaningful under the hypothesis of
\kl{commutativity}, because the latter reduces $\ZPoly$ to a combination of a
finite number of polynomials, arranged by counting modulo some numbers. This
characterization is stated in \cref{decompose-polynomial:lem}, and will
be the key ingredient in the decision procedures of $\NPoly$ inside $\ZPoly$.
To actually state the lemma, we will need some notations that will
formalize the intuitive idea of identifying tuples of integers modulo some
constant. Let $\omega \in \Nat_{\geq 1}$, we define the set
$\intro*\ModuloTypes[\omega] \defined \set{0, \dots, \omega^2} \times \set{0,
\dots, \omega - 1}$ of \intro{types modulo $\omega$}. To a number $n \in \Nat$,
we associate its \reintro{$\omega$-type} written
$\intro*\moduloType[\omega](n)$ which is defined as the pair $(t, r)$ where $t
= \min (n, \omega^2)$ and $r$ is the  remainder of the Euclidean division of
$n$ by $\omega$. This notion of type is lifted to vectors in $\Nat^p$ for any
$p \in \Nat$ by pointwise application.


\begin{lemma}
    \label{decompose-polynomial:lem}
    Let $f \colon \Sigma^* \to \Rel$ be a \kl{commutative}
    \kl{$\Rel$-polyregular function},
    where we fix the alphabet $\Sigma = \set{a_1, \dots, a_n}$.
    There exists a computable
    $\omega \in \Nat_{\geq 1}$,
    and computable 
    \kl{integer binomial polynomials} $\seqof{P_{t}}{t \in \ModuloTypes[\omega]^n}$
    such that for all $x_1, \dots, x_n \geq 0$:
    \begin{equation*}
        f\left(a_1^{x_1} \cdots a_n ^{x_n}\right) 
        = P_{\moduloType[\omega](x_1, \dots, x_n)}
        \left(
            \floor{x_1/\omega}, \dots, \floor{x_n/\omega}
        \right)
        \quad .
    \end{equation*}
\end{lemma}
\begin{proof}
    Let us first write $f \in \ZPoly$ as a linear combination 
    $f = f_+ - f_-$ where both $f_+$ and $f_-$ are in $\NPoly$.
    We 
    compute $\omega_+$ (resp. $\omega_-$)
    by
    applying
    \cref{n-poly-combinatorics:lem} 
    to $f_+$ (resp. to $f_-$).
    Finally, let $\omega$ be the least common multiple
    of $\omega_+$ and $\omega_-$, i.e. $\omega \defined \ppcm(\omega_+, \omega_-)$.
    Using this $\omega$,
    for any choice of
    $r \defined (r_1, \dots, r_n) \in \set{0, \dots, \omega - 1}$,
    there exists two \kl{natural binomial functions} $F_r^+$ and $F_r^-$
    associated to $f_+$ and $f_-$,
    such that $x_1, \dots, x_p \geq 1$:
    \begin{equation*}
        f\left(
        a_1^{\omega x_1 + r_1} \cdots a_n ^{\omega x_n + r_n}\right) 
        = F_r^+(x_1, \dots, x_p) - F_r^-(x_1, \dots, x_p) \quad .
    \end{equation*}
    Now, for large enough values of $x_1, \dots, x_p$,
    this means that 
    $f\left(
        a_1^{\omega x_1 + r_1} \cdots a_n ^{\omega x_n + r_n}\right)$
    coincides with an \kl{integer binomial polynomial},
    and we can therefore conclude selecting different values of $r$ and
    setting some subsets of variables to be assigned to the constant $0$.
\end{proof}



\begin{theorem}
    \label{decidable-n-poly:thm}
    Let $k \in \Nat$, and $f \in \ZPoly[k]$ be \kl{commutative}.
    Then, the following are equivalent:
    \begin{enumerate}
        \item \label{f-combinatorial:item} $f$ is \kl{$(k,\Nat)$-combinatorial},
        \item \label{f-npoly-combi:item} $f \in \NPoly[k]$,
    \end{enumerate}
    Furthermore, the properties are decidable,
    and conversions effective.
\end{theorem}
\begin{proof}
    The implication
    \cref{f-npoly-combi:item}
    $\implies$ \cref{f-combinatorial:item} immediately follows
    from 
    \cref{n-poly-combinatorics:lem} and \cref{decide-rat-poly-npoly:cor}.
    For the converse implication, we use \cref{decompose-polynomial:lem} 
    effectively compute a polynomial representation of $f$. That is, we obtain
    an $\omega_1 \in \Nat$ and \kl{integer binomial polynomials}
    $\seqof{P_{t}}{t \in \ModuloTypes[\omega_1]^k}$. Now, because $f$ is
    \kl{$(k,\Nat)$-combinatorial}, we also have a number $\omega_2 \in \Nat$
    such that for all \kl{pumping patterns} $q$, there exists a
    \kl{strongly natural binomial polynomial} $P$ such that $f \circ q(\omega_2 \vec{X})
    = P$ over $(\Nat_{\geq 1})^k$. By considering $\omega \defined
    \omega_1 \times \omega_2$, we can without loss of generality assume that
    $\omega_1â€¯= \omega_2$ in the rest of this proof.

    Now, consider $t \in \ModuloTypes[\omega]^k$. By
    definition, this provides us with a set $S \subseteq \set{1, \dots, k}$,
    and numbers $r_1, \dots, r_k$ between $0$ and
    $\omega^2-1$ such that for all $x_1, \dots, x_k \geq 1$, the tuple $(x_1
    \omega \ind{S}(1) + r_1, \dots, x_k \omega \ind{S}(k) + r_k)$ has type $t$.
    In particular, for all $x_1, \dots, x_k \geq 1$, the following
    equality holds:
    \begin{equation*}
        f\left(\prod_{i = 1}^k 
            a_i^{ x_i \omega \ind{S}(i) + r_i}
        \right)
        =
        P_t(\seqof{x_i}{i \in S})
    \end{equation*}

    Let us therefore consider the \kl{pumping pattern} $q \colon \Nat^k \to
    \Sigma^*$ that is simply defined as $q(X_1, \dots, X_k) \defined \prod_{i =
    1}^k a_i^{ X_i \omega \ind{S}(i) + r_i}$. Because $f$ is
    \kl{$(k,\Nat)$-combinatorial} (with parameter $\omega$), there exists a
    \kl{strongly natural binomial polynomial} $P$ such that for all $x_1,
    \dots, x_n \geq 1$, the equality $f \circ q(\omega x_1, \dots, \omega x_k)
    = P(x_1, \dots, x_k)$ holds. In particular, we conclude that over
    $(\Nat_{\geq 1})^{\card{S}}$ the polynomial $P_t$ and $P$ coincide. They
    are therefore equal as multivariate polynomials, and we conclude that $P_t$
    is a \kl{strongly natural binomial polynomial} \kl{$\Nat$-rational
    polynomial}.

    Let us now construct a new way to compute $f$, by first
    computing the \kl{$\omega$-type} of the input (which is possible in
    $\MSO$), and then computing the suitable \kl{strongly natural binomial polynomials}
    which is possible in $\NPoly$
    thanks to \cref{decide-rat-poly-npoly:cor}.
\end{proof}

It was already known that \kl{$\Rel$-polyregular functions} with unary input
that are non-negative are \kl{$\Nat$-polyregular} \cite[Proposition 2.1 p
137]{BERE10}. Let us derive this fact from our \cref{decidable-n-poly:thm}.

\begin{corollary}
    Let $f \colon \set{a}^* \to \Rel$ be a non-negative \kl{$\Rel$-polyregular function},
    then $f \in \NPoly$.
\end{corollary}
\begin{proof}
    Since $f$ has unary input, it is \kl{commutative}. Furthermore,
    $f$ is \kl{$(1,\Nat)$-combinatorial} because for all $q \colon \Nat \to
    \set{a}$ and all $\omega \geq 1$, $f(q(\omega X))$ is non-negative.
    When it is a polynomial function, it therefore belongs to $\CorrectPoly$,
    hence is a \kl{strongly natural binomial polynomial}.
    We conclude using \cref{decidable-n-poly:thm}.
\end{proof}

%\subsection{Deciding $\NSF$ inside $\NPoly$}

Let us now prove that the above characterizations of \kl{commutative}
\kl{$\Nat$-polyregular functions} can be combined with the recent advances in
the study of \kl{$\Rel$-polyregular functions} \cite{CDTL23} allowing to decide
the membership of $\ZSF$ inside $\ZPoly$. The key ingredient of this study is
the use of a semantic characterization of \kl{star-free $\Rel$-polyregular
functions} among \kl{$\Rel$-rational series} that generalizes the notion of
aperiodicity for languages to functions.

\begin{definition}[Ultimately polynomial]
    \label{ultimately-polynomial:def}
    Let $\Sigma$ be a finite alphabet. 
    A function $f \colon \Sigma^* \to \Rel$
    is \intro{ultimately polynomial}
    when there exists $N_0 \in \Nat$ such that
    for all $n \in \Nat$,
    for all \kl{pumping pattern} $q \colon \Nat^n \to \Sigma^*$,
    there exists a polynomial $P \in \Rat[X_1, \dots, X_n]$
    such that:
    \begin{equation*}
        f \circ p = P
        \quad 
        \text{ over } (\Nat_{\geq N_0})^n
        \quad .
    \end{equation*}
\end{definition}

It was observed in \cite[Claim V.6]{CDTL23}, and in \cite[Claim 7.45, Lemma
7.53]{DOUE23} that a regular language $L$ is \emph{star-free} if and only if its
indicator function $\ind{L}$ is \kl{ultimately polynomial}. We can now answer
\cite[Conjecture 7.61]{DOUE23} positively, by proving that $\NPoly \cap \ZSF =
\NSF$.

%\begin{example}[restate=aperidic-ultimately-polynomial:ex,label=aperidic-ultimately-polynomial:ex]
%    \proofref{aperidic-ultimately-polynomial:ex}
%    A language $L$ is \kl(language){aperiodic} if and only if 
%    $\ind{L}$ is \kl{ultimately polynomial}.
%\end{example}
%\begin{proof}
%    Assume that $\ind{L}$ is \kl{ultimately polynomial}. Let $u,v,w \in
%    \Sigma^*$. There exists a polynomial $P \in \Rat[X]$ and a number $N_0 \in
%    \Nat$, such that $\ind{L}(u v^n w) = P(n)$ for all $n \geq N_0$. Because
%    $\ind{L}$ has co-domain included in $\set{0,1}$, so does $P$, which proves
%    that $P$ is a constant polynomial. Then, $\ind{L}(u v^{n+1} w) = P(n+1) =
%    P(n) = \ind{L}(uv^n w)$ for all $n \geq N_0$.
%
%    Conversely, assume that $L$ is \kl(language){aperiodic}, let $n \in \Nat$ be a number, and
%    let $\alpha_0$, $w_1$, $\alpha_1$, $\ldots$, $\alpha_{n-1}$, $w_n$, $\alpha_n$
%    be words in $\Sigma^*$. Because $L$ is \kl(language){aperiodic}, the language
%    $L$ is recognized by an \kl(monoid){aperiodic} finite monoid $M$, via a
%    morphism $\mu \colon \Sigma^* \to M$ and an accepting part $F \subseteq M$.
%    Because $M$ is a \kl(monoid){aperiodic}, there exists $N_0$
%    such that for all $m \in M$, $m^{N_0+1} = m^{N_0}$. As a consequence,
%    for all $1 \leq i \leq n$,
%    whenever $x_i \geq N_0$, we have $\mu(w_i)^{x_i} = \mu(w_i)^{N_0}$.
%    Therefore, for all $x_1, \dots, x_n \geq N_0$, we have:
%    \begin{align*}
%        \ind{L}\left(\alpha_0 \prod_{i= 1}^n w_i^{x_i} \alpha_i \right) 
%        &= 
%        \ind{P}\left(\mu(\alpha_0) \cdot \prod_{i= 1}^n \mu(w_i)^{x_i} \cdot \mu(\alpha_i)\right)
%        & \text{ because $M$ recognizes $L$}
%        \\
%        &= 
%        \ind{P}\left(\mu(\alpha_0) \cdot \prod_{i= 1}^n \mu(w_i)^{N_0} \cdot \mu(\alpha_i)\right)
%        & \text{ by aperiodicity }
%        \\
%        &\defined P(x_1, \dots, x_n) & \text{ constant polynomial }
%    \end{align*}
%    Hence, $\ind{L}$ is \kl{ultimately polynomial}.
%\end{proof}

\begin{theorem}
    \label{zsf-npoly-nsf:thm}
    Let $\Sigma$ be a finite alphabet, 
    and $f \colon \Sigma^* \to \Rel$ be a \kl{commutative}
    \kl{$\Nat$-polyregular function}.
    Then, the following are equivalent:
    \begin{enumerate}
        \item \label{zsf-npoly-nsf:thm:up:item} $f$ is \kl{ultimately polynomial},
        \item \label{zsf-npoly-nsf:thm:zsf:item} $f \in \ZSF$,
        \item \label{zsf-npoly-nsf:thm:nsf:item} $f \in \NSF$.
    \end{enumerate}
    Furthermore, membership is decidable and conversions are effective.
    \proofref{zsf-npoly-nsf:thm}
\end{theorem}
\begin{proof}
    The implication \cref{zsf-npoly-nsf:thm:nsf:item} $\Rightarrow$
    \cref{zsf-npoly-nsf:thm:zsf:item} is immediate since $\NSF \subseteq \ZSF$.
    Furthermore,
    \cref{zsf-npoly-nsf:thm:zsf:item} implies \cref{zsf-npoly-nsf:thm:up:item}
    following previous results for \kl{star-free $\Rel$-polyregular functions}
    \cite{CDTL23}.

    For the implication \cref{zsf-npoly-nsf:thm:up:item} $\Rightarrow$
    \cref{zsf-npoly-nsf:thm:nsf:item}, let us assume that $f$ is \kl{ultimately
    polynomial}. We prove the result by induction on the size of the alphabet
    $\Sigma$. By definition, there exists $N_0 \in \Nat$, and $P \in
    \Rat[\seqof{X_a}{a \in \Sigma}]$ such that: \begin{equation*} f\left(
        \prod_{a \in \Sigma} a^{X_a} \right) = P(\seqof{X_a}{a \in \Sigma})
        \quad \text{ when } \forall a \in \Sigma, X_a \geq N_0 \quad .
    \end{equation*} It is clear that $P$ is \kl{represented} by a
    \kl{$\Nat$-polyregular function}, namely, $f$ partially applied to the word
    $\prod_{a \in \Sigma} a^{N_0}$, and therefore is in fact represented by a
    \kl{star-free $\Nat$-polyregular function} thanks to
    \cref{decide-rat-poly-npoly:cor}.
    For every letter $a \in \Sigma$ and number $0 \leq n \leq N_0$, there exists, by induction hypothesis,
    a \kl{star-free $\Nat$-polyregular function} $g_a^n$ that represents the
    function $f_{a^n} \colon (\Sigma \setminus \set{a})^* \to \Rel$
    that maps $u \in (\Sigma \setminus \set{a})^*$ to $f(a^n u)$.

    Let us now define the function $g \colon \Sigma^* \to \Rel$ as follows:
    \begin{equation*}
        g \colon w \mapsto \begin{cases}
            g_{a^n} (w) & \text{ if } \card[a]{w} = n \text{ for some } a \in \Sigma \text{ and } n \leq N_0 \\
            P(\seqof{\card[a]{w}}{a \in \Sigma}) & \text{ otherwise }
        \end{cases}
    \end{equation*}
    We conclude that $g$ is a \kl{star-free $\Nat$-polyregular function}, and by definition
    $f = g$.
\end{proof}
