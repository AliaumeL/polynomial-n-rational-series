%! TeX program = xelatex
%! lang = en-US
\section{Beyond Polynomials}
\label{beyond-polynomials:sec}
\label{star-free:sec}

In this section, we leverage the decidability results of \cref{polynomials:sec}
to decide membership in $\NPoly$
inside $\ZPoly$ and membership in $\NSF$ inside $\NPoly$, both under the extra
assumption of \kl{commutativity}. 
To characterize $\NPoly$ inside $\ZPoly$ we introduce the notion of
\kl{$(k,\Nat)$-combinatorial} function
(\cref{k-combinatorial:def}), following the spirit of revious
characterizations of subclasses of $\ZPoly$ in terms of \emph{polynomial
pumping arguments} \cite{DOUE21,DOUE22,CDTL23}.

\begin{definition}
    \label{k-combinatorial:def}
    Let $k \in \Nat$, and $f \colon \Sigma^* \to \Rel$
    be a \kl{$\Rel$-polyregular function}. The function $f$ is 
    \intro{$(k,\Nat)$-combinatorial} if there exists $\omega \in \Nat$,
    such that
    for all
    \kl{pumping patterns} $q \colon \Nat^k \to \Sigma^*$,
    there exists a \kl{strongly natural binomial polynomial} $P$
    satisfying:
    \begin{equation*}
        f \circ q(\omega X_1,\dots, \omega X_k)
        = 
        P
        \quad 
        \text{ over } (\Nat_{\geq 1})^k
        \quad .
    \end{equation*}
\end{definition}

\AP Let us now introduce a decomposition of \kl{commutative}
\kl{$\Rel$-polyregular functions} into \kl{integer binomial polynomials}. Given
a number $\omega \in \Nat$, let us write $\intro*\ModuloTypes[\omega]^k$ for
the collection of pairs $(S, \vec{r})$ where $S \subseteq \set{1, \dots, k}$
and $r \in \set{0, \dots, \omega - 1}^k$. To a tuple $\vec{x} \in \Nat^k$, one
can associate its \intro{$\omega$-type}, written
$\intro*\moduloType[\omega](\vec{x})$, which is the pair $(S, \vec{r})$ where
$S = \set{i \in \set{1, \dots, k} \mid x_i \geq \omega}$ and $\vec{r} = (x_i
\mod \omega)_{i \in \set{1, \dots, k}}$.

\begin{lemma}[restate=decompose-polynomial:lem,label=decompose-polynomial:lem]
    \proofref{decompose-polynomial:lem}
    Let $f \colon \Sigma^* \to \Rel$ be a \kl{commutative}
    \kl{$\Rel$-polyregular function},
    where we fix the alphabet $\Sigma = \set{a_1, \dots, a_k}$.
    There exists a computable
    $\omega \in \Nat_{\geq 1}$,
    and computable 
    \kl{integer binomial polynomials} 
    $P_{(S,\vec{r})} \in \Rat[\seqof{X_i}{i \in S}]$ for $(S,\vec{r}) \in \ModuloTypes[\omega]^k$,
    such that for all $\vec{x} \in \Nat^k$,
    \begin{equation*}
        f\left(
            \prod_{i = 1}^k a_i^{x_i}
        \right)
        = P_{(S, \vec{r})}
        \left(
            \seqof{\floor{x_i / \omega}}{i \in S}
        \right)
        \text{ where } (S, \vec{r}) = \moduloType[\omega](\vec{x})
        \quad .
    \end{equation*}
\end{lemma}


\begin{theorem}
    \label{decidable-n-poly:thm}
    Let $k,d \in \Nat$, and $f \in \ZPoly[d]$ be \kl{commutative}
    over an alphabet of size $k$.
    Then, the following are equivalent:
    \begin{enumerate}
        \item \label{f-combinatorial:item} $f$ is \kl{$(k,\Nat)$-combinatorial},
        \item \label{f-npoly-combi:item} $f \in \NPoly[d]$,
    \end{enumerate}
    Furthermore, the properties are decidable,
    and conversions effective.
\end{theorem}
\begin{proof}
    Let $f \in \ZPoly[d]$ be \kl{commutative} over an alphabet of size $k$.
    We apply \cref{decompose-polynomial:lem} to compute an $\omega \in \Nat$ and
    \kl{integer binomial polynomials} $\seqof{P_{(S,\vec{r})}}{(S,\vec{r}) \in
    \ModuloTypes[\omega]^k}$ such that for all $\vec{x} \in \Nat^k$,
    $f\left(\prod_{i = 1}^k a_i^{x_i}\right) = P_{(S, \vec{r})}(\seqof{\floor{x_i / \omega}}{i \in S})$,
    where $(S, \vec{r}) = \moduloType[\omega](\vec{x})$.
    We are first going to prove that $f \in \NPoly[d]$ if and only if $P_{(S,
    \vec{r})}$ is a \kl{strongly natural binomial polynomial} for all $(S,
    \vec{r}) \in \ModuloTypes[\omega]^k$. This will also provide decidability
    of \cref{f-npoly-combi:item}, since one can decide whether a
    polynomial is \kl{strongly natural binomial polynomial} using
    \cref{decide-rat-poly-npoly:cor}.

    Assume that $f \in \NPoly$, then by definition, the polynomials $P_{(S,
    \vec{r})}$ are \kl{represented} by an \kl{$\Nat$-polyregular function},
    hence are \kl{strongly natural binomial polynomials}
    (\cref{decide-rat-poly-npoly:cor}). Conversely, if
    $P_{(S, \vec{r})}$ is a \kl{strongly natural binomial polynomial} for all
    $(S, \vec{r}) \in \ModuloTypes[\omega]^k$, then $f \in \NPoly$ because one
    can compute the \kl{$\omega$-type} of the input using a \kl{polyregular
    function}, and then compute the suitable \kl{strongly natural binomial
    polynomial} $P_{(S, \vec{r})}$ which is possible in $\NPoly$ thanks to
    \cref{decide-rat-poly-npoly:cor}. The resulting composition
    belongs to $\NPoly$ thanks to
    \cref{stability-polyregular:lemma},
    and we conclude that $f \in \NPoly[d]$ because it has \kl{growth rate} at
    most $d$
    (\cref{polyregular-polynomial-growth:lemma}).

    Note that the same proof scheme can be used to conclude that
    \cref{f-npoly-combi:item} implies
    \cref{f-combinatorial:item}. For the converse implication, we are
    going to introduce $\omega_2$ associated to the fact that $f$ is
    \kl{$(k,\Nat)$-combinatorial}. Because polynomials \kl{represented} by
    \kl{$\Nat$-polyregular functions} and \kl{integer binomial polynomials} are
    both closed under multiplication of their input by a constant factor, we can assume that
    $\omega = \omega_2$ in the decomposition of $f$.
    Now, consider $(S, \vec{r}) \in \ModuloTypes[\omega]^k$. 
    Notice that for all vectors $\vec{x} \in (\Nat_{\geq 1})^k$, 
    the vector $(x_1 \omega \ind{S}(1) + r_1, \dots, x_k \omega \ind{S}(k) + r_k)$ has
    \kl{$\omega$-type} $(S, \vec{r})$.
    In particular, the following
    equality holds:
    \begin{equation*}
        f\left(\prod_{i = 1}^k 
            a_i^{ x_i \omega \ind{S}(i) + r_i}
        \right)
        =
        P_{(S, \vec{r})}(\seqof{x_i}{i \in S})
        \quad  \forall \vec{x} \in (\Nat_{\geq 1})^k
        \quad .
    \end{equation*}

    Let us therefore consider the \kl{pumping pattern} $q \colon \Nat^k \to
    \Sigma^*$ that is simply defined as $q(X_1, \dots, X_k) \defined \prod_{i =
    1}^k a_i^{ X_i \ind{S}(i) + r_i}$. 
    Because $f$ is \kl{$(k,\Nat)$-combinatorial} with parameter $\omega$,
    there exists a \kl{strongly natural binomial polynomial} $P \in \Rat[X_1,
    \dots, X_k]$ such that $f \circ q (\omega X_1, \dots, \omega X_k) = P (X_1, \dots, X_k)$ 
    over $(\Nat_{\geq 1})^k$.
    This proves that
    $P_{(S, \vec{r})}(\seqof{X_i}{i \in S})$
    equals
    $P(X_1, \dots, X_k)$ as polynomials,  hence,
    that $P_{(S, \vec{r})}$ is a \kl{strongly natural binomial polynomial}
    for all $(S, \vec{r}) \in \ModuloTypes[\omega]^k$. We have proven that
    $f \in \NPoly[d]$.
\end{proof}

It was already known that \kl{$\Rel$-polyregular functions} with unary input
that are non-negative are \kl{$\Nat$-polyregular} \cite[Proposition 2.1 p
137]{BERE10}. Let us derive this fact from our \cref{decidable-n-poly:thm}.

\begin{corollary}
    Let $f \colon \set{a}^* \to \Rel$ be a non-negative \kl{$\Rel$-polyregular function},
    then $f \in \NPoly$.
\end{corollary}
\begin{proof}
    Since $f$ has unary input, it is \kl{commutative}. Furthermore,
    $f$ is \kl{$(1,\Nat)$-combinatorial} because for all $q \colon \Nat \to
    \set{a}$ and all $\omega \geq 1$, $f(q(\omega X))$ is non-negative.
    When it is a polynomial function, it therefore belongs to $\CorrectPoly$,
    hence is a \kl{strongly natural binomial polynomial}.
    We conclude using \cref{decidable-n-poly:thm}.
\end{proof}

%\subsection{Deciding $\NSF$ inside $\NPoly$}

Let us now prove that the above characterizations of \kl{commutative}
\kl{$\Nat$-polyregular functions} can be combined with the recent advances in
the study of \kl{$\Rel$-polyregular functions} \cite{CDTL23} allowing to decide
the membership of $\ZSF$ inside $\ZPoly$. The key ingredient of this study is
the use of a semantic characterization of \kl{star-free $\Rel$-polyregular
functions} among \kl{$\Rel$-rational series} that generalizes the notion of
aperiodicity for languages to functions.

\begin{definition}[Ultimately polynomial]
    \label{ultimately-polynomial:def}
    Let $\Sigma$ be a finite alphabet. 
    A function $f \colon \Sigma^* \to \Rel$
    is \intro{ultimately polynomial}
    when there exists $N_0 \in \Nat$ such that
    for all $k \in \Nat$,
    for all \kl{pumping pattern} $q \colon \Nat^k \to \Sigma^*$,
    there exists a polynomial $P \in \Rat[X_1, \dots, X_k]$
    such that:
    \begin{equation*}
        f \circ q = P
        \quad 
        \text{ over } (\Nat_{\geq N_0})^k
        \quad .
    \end{equation*}
\end{definition}

It was observed in \cite[Claim V.6]{CDTL23}, and in \cite[Claim 7.45, Lemma
7.53]{DOUE23} that a regular language $L$ is \emph{star-free} if and only if its
indicator function $\ind{L}$ is \kl{ultimately polynomial}. We can now answer
\cite[Conjecture 7.61]{DOUE23} positively, by proving that $\NPoly \cap \ZSF =
\NSF$.

%\begin{example}[restate=aperidic-ultimately-polynomial:ex,label=aperidic-ultimately-polynomial:ex]
%    \proofref{aperidic-ultimately-polynomial:ex}
%    A language $L$ is \kl(language){aperiodic} if and only if 
%    $\ind{L}$ is \kl{ultimately polynomial}.
%\end{example}
%\begin{proof}
%    Assume that $\ind{L}$ is \kl{ultimately polynomial}. Let $u,v,w \in
%    \Sigma^*$. There exists a polynomial $P \in \Rat[X]$ and a number $N_0 \in
%    \Nat$, such that $\ind{L}(u v^n w) = P(n)$ for all $n \geq N_0$. Because
%    $\ind{L}$ has co-domain included in $\set{0,1}$, so does $P$, which proves
%    that $P$ is a constant polynomial. Then, $\ind{L}(u v^{n+1} w) = P(n+1) =
%    P(n) = \ind{L}(uv^n w)$ for all $n \geq N_0$.
%
%    Conversely, assume that $L$ is \kl(language){aperiodic}, let $n \in \Nat$ be a number, and
%    let $\alpha_0$, $w_1$, $\alpha_1$, $\ldots$, $\alpha_{n-1}$, $w_n$, $\alpha_n$
%    be words in $\Sigma^*$. Because $L$ is \kl(language){aperiodic}, the language
%    $L$ is recognized by an \kl(monoid){aperiodic} finite monoid $M$, via a
%    morphism $\mu \colon \Sigma^* \to M$ and an accepting part $F \subseteq M$.
%    Because $M$ is a \kl(monoid){aperiodic}, there exists $N_0$
%    such that for all $m \in M$, $m^{N_0+1} = m^{N_0}$. As a consequence,
%    for all $1 \leq i \leq n$,
%    whenever $x_i \geq N_0$, we have $\mu(w_i)^{x_i} = \mu(w_i)^{N_0}$.
%    Therefore, for all $x_1, \dots, x_n \geq N_0$, we have:
%    \begin{align*}
%        \ind{L}\left(\alpha_0 \prod_{i= 1}^n w_i^{x_i} \alpha_i \right) 
%        &= 
%        \ind{P}\left(\mu(\alpha_0) \cdot \prod_{i= 1}^n \mu(w_i)^{x_i} \cdot \mu(\alpha_i)\right)
%        & \text{ because $M$ recognizes $L$}
%        \\
%        &= 
%        \ind{P}\left(\mu(\alpha_0) \cdot \prod_{i= 1}^n \mu(w_i)^{N_0} \cdot \mu(\alpha_i)\right)
%        & \text{ by aperiodicity }
%        \\
%        &\defined P(x_1, \dots, x_n) & \text{ constant polynomial }
%    \end{align*}
%    Hence, $\ind{L}$ is \kl{ultimately polynomial}.
%\end{proof}

\begin{theorem}
    \label{zsf-npoly-nsf:thm}
    Let $\Sigma$ be a finite alphabet, 
    and $f \colon \Sigma^* \to \Rel$ be a \kl{commutative}
    \kl{$\Nat$-polyregular function}.
    Then, the following are equivalent:
    \begin{enumerate}
        \item \label{zsf-npoly-nsf:thm:up:item} $f$ is \kl{ultimately polynomial},
        \item \label{zsf-npoly-nsf:thm:zsf:item} $f \in \ZSF$,
        \item \label{zsf-npoly-nsf:thm:nsf:item} $f \in \NSF$.
    \end{enumerate}
    Furthermore, membership is decidable and conversions are effective.
    \proofref{zsf-npoly-nsf:thm}
\end{theorem}
\begin{proof}
    The implication \cref{zsf-npoly-nsf:thm:nsf:item} $\Rightarrow$
    \cref{zsf-npoly-nsf:thm:zsf:item} is immediate since $\NSF \subseteq \ZSF$.
    Furthermore,
    \cref{zsf-npoly-nsf:thm:zsf:item} implies \cref{zsf-npoly-nsf:thm:up:item}
    following previous results for \kl{star-free $\Rel$-polyregular functions}
    \cite[Theorem V.13]{CDTL23}.

    For the implication \cref{zsf-npoly-nsf:thm:up:item} $\Rightarrow$
    \cref{zsf-npoly-nsf:thm:nsf:item}, let us assume that $f$ is \kl{ultimately
    polynomial}. We prove the result by induction on the size of the alphabet
    $\Sigma$. By definition, there exists $N_0 \in \Nat$, and $P \in
    \Rat[\seqof{X_a}{a \in \Sigma}]$ such that:

    \begin{equation*} f\left(
        \prod_{a \in \Sigma} a^{x_a} \right)
        = 
        P(\seqof{x_a}{a \in \Sigma})
        \quad \forall \vec{x} \in (\Nat_{\geq N_0})^{\Sigma} \quad .
    \end{equation*}

    It is clear that $\translate{N_0}(P)$ is \kl{represented} by an
    \kl{$\Nat$-polyregular function}, namely, $f_u \colon w \mapsto f(uw)$
    where $u \defined \prod_{a \in \Sigma} a^{N_0}$, and is therefore represented by a
    \kl{star-free $\Nat$-polyregular function} thanks to
    \cref{decide-rat-poly-npoly:cor}.
    For every letter $a \in \Sigma$ and number $0 \leq n \leq N_0$, there exists, by induction hypothesis,
    a \kl{star-free $\Nat$-polyregular function} $g_{a^n}$ that \kl{represents} the
    function $f_{a^n} \colon (\Sigma \setminus \set{a})^* \to \Rel$
    that maps $w \in (\Sigma \setminus \set{a})^*$ to $f(a^n w)$.

    Let us conclude by computing $f$ 
    using the following \kl{star-free $\Nat$-polyregular function} $g \colon \Sigma^* \to \Rel$:
    \begin{equation*}
        g \colon w \mapsto \begin{cases}
            g_{a^n} (w) & \text{ if } \card[a]{w} = n \text{ for some } a \in \Sigma \text{ and } n \leq N_0 \\
            \translate{N_0}(P)(\seqof{\card[a]{w} - N_0}{a \in \Sigma}) & \text{ otherwise }
        \end{cases}
        \qedhere
    \end{equation*}
\end{proof}
