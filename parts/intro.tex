%! TeX program = xelatex
%! lang = en-US
% MAIN MATTER
\section{Introduction}
\label{introduction:sec}

\AP
Traditional results from automata theory state the equivalence of languages
defined in terms of deterministic finite automata and regular expressions
\cite{kleene1956representation}, Monadic Second Order Logic ($\intro*\MSO$)
\cite{buchi1960weak}, or finite monoids \cite{schutzenberger1961definition}.
Among regular languages, there exists a robust subclass sharing similar
characterizations, namely the \emph{star-free} regular languages. These are
obtained via counter-free (minimal) automata \cite{mcnaughton1971counter},
represented by star-free regular expressions \cite{schutzenberger1965finite},
definable in First Order Logic ($\intro*\FO$) \cite{perrin1986first}, and recognized
by aperiodic monoids \cite{schutzenberger1965finite}. It is decidable whether a
regular language is aperiodic, thanks to the characterizations in terms of
minimal automaton and/or syntactic monoid.

\AP There have been recurrent attempts to generalize the notions of regularity
from languages to functions, leading to classes of various expressiveness (for
instance, sequential, rational, regular, and \kl{polyregular functions})
\cite{EM65,Aho1969,eilenberg1974automata,EM02}. In this paper, we will focus on
\intro{polyregular functions} ($\intro*\Poly$), that shares with regular
languages its characterizations in terms of logic (via $\MSO$ interpretations),
automata (via pebble automata), and adds new bridges with programming languages
via its relationships with lambda-terms and so-called for-transducers
\cite{bojanczyk2019string}. As for regular languages, the class $\intro*\SF$ of
\intro{star-free polyregular function} can equivalently be introduced in terms
of first-order definability, counter-free pebble transducers, and suitable
restrictions of for-tranducers.

\AP
Classical problems, including the decidability of aperiodicity, become
difficult in the case of \kl{polyregular functions}, due to the lack of
canonical objects akin to the syntactic monoid or the minimal automaton. For
sequential functions (that admit a canonical object), aperiodicity is decidable
\cite{choffrut03}, and more recently, aperiodicity has been proven decidable
for rational functions \cite{filiot2016aperiodicity,filiot2018canonical}. The
problem remains open for regular functions, although it has been proven
decidable when changing the semantics of function equality to account for the
\emph{origins} in the output \cite{bojanczyk14}. To construct subclasses of
\kl{polyregular function}, an interesting parameter is the \intro{growth rate}
of a function $f$, which is given by a number $k \in \Nat$, which can be used
to create a strict hierarchy inside $\Poly$. All functions in $\Poly$ have
\intro{polynomial growth}, and we can write $\Poly[k]$ for the \kl{polyregular
functions} of \kl{growth rate} $k$. It has been shown that the parameter $k$
controls the maximal complexity of the $\MSO$ interpretation needed to
represent the function \cite{bojanczyk2022transducers}.

\AP
Another way to approach the problem of deciding if a \kl{polyregular function}
is \kl{star-free}, is to not restrict the computational power (via the
\kl{growth rate}), nor change the semantics (by adding origins), but consider
restrictions of the output alphabet. In particular, there have been successful
results proven on \emph{unary polyregular functions}, also known as
\kl{$\Nat$-polyregular functions} ($\intro*\NPoly$)
\cite{doueneau2021pebble,doueneau2022hiding}. For instance, the \kl{growth
rate} $k$ of a function $f \in \NPoly$ provides the minimal number of pebbles
needed to compute $f$ \cite{doueneau2021pebble}, which does not hold on $\Poly$
\cite{bojanczyk2022transducers}. Let us remark that the restriction to
\emph{unary output} in the case of \kl{polyregular functions} can be lifted to
outputs in the free commuative semigroup generated by a finite alphabet
$\Gamma$. In this sense, the shift to \emph{unary output} is really about
enforcing commutativity on the output.

\AP
Recently, aperiodicity has been shown decidable over a restricted class of
\kl{polyregular functions} where the ouptut belongs to $\Rel$ instead of
$\Nat$, that are called \kl{$\Rel$-polyregular functions} ($\intro*\ZPoly$)
\cite{LOPEZ23b}. These functions generalize \kl{$\Nat$-polyregular functions}
by allowing negative outputs, and therefore enabling a limited form of
backtracking. As for the unary outputs, these results generalize to
\kl{polyregular functions} having outputs in the free commutative \emph{group}
generated by a finite alphabet $\Gamma$. The decidability of aperiodicity for
\kl{$\Rel$-polyregular functions} relies on the construction of a canonical
object called the \emph{residual transducer}, the latter being essentially
based on differences between functions, crucially leveraging negative outputs
(i.e., the presence of inverse elements). Although the proof method does not carry
from $\Rel$-output functions to $\Nat$-output functions, it was conjectured
that the semantic characterization of \kl{star-free $\Rel$-polyregular
functions} ($\intro*\ZSF$) would continue to characterize \kl{star-free
$\Nat$-polyregular functions} ($\intro*\NSF$). 

\begin{conjecture}[{\cite[Conjecture 7.61]{gaetanphd}}]
    \label{zsf-nsf:conjecture}
    Let $k \in \Nat$.
    A function $f \in \NPoly[k]$
    belongs to $\NSF[k]$ if and only if
    it is \kl{ultimately polynomial} (defined page \kpageref{ultimately polynomial}).
    In particular,
    $\NSF[k] = \ZSF[k] \cap \NPoly$.
\end{conjecture}

\AP
It is well known that $\NPoly$ (resp. $\ZPoly$) is proper subclass respectively
of \intro{$\Nat$-rational series} ($\intro*\NRat$) (resp. of \intro{$\Rel$-rational
series} $\intro*\ZRat$), that have been characterized in terms of \kl{growth rate},
ambiguity, and a notion of \emph{quantitative} $\MSO$
\cite{schutzenberger1962,kreutzer2013}, and therefore can benefit from generic
theorems obtained on these \cite{berstel2011noncommutative}. However, for these
larger classes of functions, several competing notions of aperiodicity exist
\cite{droste2019aperiodic,reutenauer_series_1980,LOPEZ23b}, and the
decidability of the ones that extends $\ZSF$ and $\NSF$ remains open.
Furthermore, the decidability of $\NRat$ inside $\ZRat$ is also a longstanding
open problem, that was to the knowledge of the authors, only solved by
\textcite{KARH77} in the case of \kl{$\Rel$-rational series} that compute
\emph{polynomials}, with an incorrect proof. Furthermore, decidability of
$\NPoly$ inside $\ZPoly$ (resp. $\NSF$ inside $\ZSF$) remains an open problem
\cite[Open question 5.55]{gaetanphd}.

\AP
We refer the reader to \cref{previously-known-inclusions:fig} to get an
overview of the different classes of functions appearing in the paper. Arrows
denote strict inclusions, and effectiveness (both in terms of decidability and
of effective representation) is represented by thick double arrows. Inclusions
that are suspected to be effective are represented using a dashed arrow
together with a question mark.


\begin{figure}
    \centering
    \includestandalone[width=7cm]{tikz/class-inclusions}
    \caption{
        Decidability and inclusions of classes of functions,
        arranged along two axes. The first one is the complexity
        of the output alphabet ($\Nat$, $\Rel$, $\Sigma$). The second
        one is the allowed computational power
        (star-free polyregular functions, polyregular functions, 
        rational series).
    }
    \label{previously-known-inclusions:fig}
\end{figure}


\paragraph*{Contributions.} This paper focuses on \kl{$\Nat$-polyregular
functions} that are furthermore \kl{commutative}. Remark that this enforces a
commutativity property both on the input alphabet and on the output alphabet.
In this restricted setting, we answer positively to \cref{zsf-nsf:conjecture},
and prove that the membership problems between $\NSF$, $\ZSF$, $\NPoly$, and
$\ZPoly$ are all decidable, with effective conversion algorithms. This
effectively shows that all arrows in the lower left square of
\cref{previously-known-inclusions:fig} are decidable in the \kl{commutative}
setting. Furthermore, we characterize \kl{commutative} \kl{$\Nat$-polyregular
function} as the class of \kl{$\Rel$-polyregular functions} that are
\kl{combinatorial} (defined page \kpageref{combinatorial}), which is a semantic
property akin to the one \kl{ultimate polynomiality} that characterizes $\ZSF$.
As a byproduct of our analysis, we provide a counter example to the
characterization of polynomials computed by \kl{$\Nat$-rational series} given
by \textcite[Theorem 3.3, page 4; re-introduced as \cref{karh:thm}]{KARH77}.

Finally, we make a first step towards understanding the non-commutative case by
introducing a canonical model of computation for \kl{$\Nat$-polyregular
functions} built upon residuals, called the \kl{residual transducer}. This
residual transducer is obtained by shifting attention from the notion of
equivalence relations of finite index over $\Sigma^*$, used in traditional
automata theory and in the study of $\ZPoly$, to the notion of
\kl{well-quasi-orderings}. The residual transducer is effectively computable if
$f$ is \kl{commutative} and \kl{$\Nat$-polyregular}, and it is conjectured to
be computable for all functions in $\NPoly$. 

The approach taken in this paper avoids leveraging tools from the theory of
factorizations forests in finite monoids \cite{simon90}, which has been the
traditional method used to understand (commutative output) \kl{polyregular
functions} \cite{doueneau2021pebble,doueneau2022hiding,LOPEZ23b}, and instead
focus on intrinsic description of the functions themselves (via canonical
computational models such as the \kl{residual transducer} of
\cref{residual-transducer:def}, or explicit encoding/decoding into polynomials
via \cref{decompose-polynomial:lem}). 


\paragraph*{Outline of the paper.} In \cref{preliminaries:sec}, we introduce
the multiple characterizations of \kl{$\Nat$-polyregular function} (resp.
$\Rel$-polyregular functions), show that one can decide if a function $f \in
\ZPoly$ is \kl{commutative} (\cref{decidable-commutative-poly:lemma}), and give
the basic definitions used on multivariate polynomials. In
\cref{polynomials:sec}, we focus on \emph{polynomials}, by introducing the
\cref{karh:thm} of \textcite{KARH77}, providing a counter-example in
\cref{thm:counter-example}, and an alternative characterization in
\cref{corrected-version:thm}. In \cref{beyond-polynomials:sec}, we leverage the
results over polynomials to decide $\NPoly$ inside $\ZPoly$ in the
\kl{commutative} case (\cref{decidable-n-poly:thm}), and prove that
\cref{zsf-nsf:conjecture} holds for \kl{commutative} functions
(\cref{zsf-npoly-nsf:thm}). Finally, in \cref{beyond-commutative:sec}, we
introduce the notion of \kl{residual transducer}
(\cref{residual-transducer:def}), and prove in \cref{non-commutative-npoly:thm}
that it characterizes $\NPoly$ inside $\ZPoly$ through a notion of
\kl{well-quasi-ordered} collection of residuals.
