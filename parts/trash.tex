
\subsection{Polyblind functions}

We are going to prove that polyblind functions are essentially
commutative.

\AP Given $q,k \in \Nat$, we define $\MSO^q_k$ to be the collection of types of
tuples of at most $k$ variables using quantifier rank at most $q$. We extend
the notation to a function $\MSO^q_k (u)$ that assigns to a word $u$ the number
of representative for each type.

\begin{lemma}
    Let $q \in \Nat$. The image
    $\MSO^q_1(\Sigma^*)$ is a semilinear set.
\end{lemma}
\begin{proof}
    Here is a context-free grammar that enumerates words
    in $\Sigma^*$ with letters colored by their $\MSO^q_1$ type.
    The initial non-terminal decides the global $\MSO^q$ type of the word,
    and given a non-terminal with an $\MSO^q$-type, we can split it in three
    by choosing a letter $a \in \Sigma$, an $\MSO^q$-type for the left,
    and an $\MSO^q$-type for the right, so that the types are coherent.
    We just have to remember the $\MSO^q$ type of the left and right
    of the current non-terminal to do that properly.

    By the Parikhâ€™s theorem, the image of this is a semilinear set, that
    precisely computes $\MSO^q_1(\Sigma^*)$.
\end{proof}

\AP
Recall that a \intro{polyblind function} is a function such that.

\begin{lemma}
    Let $f \colon \Sigma^* \to \Rel$ be a \kl{polyblind function}.
    Then, there exists a computable function $g \colon \Nat^p \to \Rel$,
    that is \kl{commutative} and such that the following are equivalent:
    \begin{itemize}
        \item $g$ is $\Nat$-polyregular
        \item $f$ is $\Nat$-polyregular
    \end{itemize}
\end{lemma}

\AP
Look at the image of $\MSO^q_k$, is it semi-algebraic instead of semi-linear?
\begin{lemma}
    $\MSO^q_k(\Sigma^*)$ is a set of tuples that is obtained as a finite union 
    images of polynomials?
\end{lemma}

\begin{center}
    \begin{tabular}{c|cc}
        \toprule
        & \textbf{Commutative} & \textbf{General} \\
        \midrule
        \textbf{Commutative}
        and \textbf{Invertible} & commutative $\ZPoly$ & $\ZPoly$ \\
        \textbf{Commutative} & commutative $\NPoly$ & $\NPoly$ \\
        \textbf{General} & ? & polyregular 
    \end{tabular}
\end{center}


\begin{conjecture}
    For commutative functions, the residual transducer 
    is helpful.
\end{conjecture}

\begin{fact}
    \label{translation-invariance:fact}
    The following sets are stable under \kl{translations}
    $\translate{K}$,
    where $K \in \Nat$ is non-negative:
    \begin{itemize}
        \item $\CorrectPoly$,
        \item \kl{$\Nat$-rational polynomials},
        \item Polynomials \kl{represented}
            by \kl{star-free $\Nat$-polyregular functions}.
    \end{itemize}
\end{fact}

\begin{conjecture}
    Let $f \in \NPoly$. The following are equivalent,
    \begin{enumerate}
        \item $f \in \ZSF$,
        \item the \kl{$k$-residual transducer} of $f$
            is \kl{counter-free},
            and its labels belong to $\ZSF$.
    \end{enumerate}
\end{conjecture}
\begin{proof}
    If it has a counter free residual transducer recursively, then
    it clearly belongs to $\ZSF$.

    % TODO: mix orderings and trees and maximal elements :(

    Now, assume that $L$ is aperiodic, and let $(q,w^n)$ be a counter with $n
    \geq 1$. We know that $qw \equiv_L q$ because the language $L$ is
    aperiodic. Let us write $t \defined \delta(q,w)$, we know that $t \equiv_L
    q$. Assume by contradiction that $t$ and $q$ are incomparable for the
    prefix relation. Let us split $w = w_1 w_2$ where $w_1$ is the shortest
    prefix of $w$ such that $s_0 \defined \delta(q,w_1)$ is an ancestor of $q$
    and of $t$ for the prefix relation, it must exist because $\delta(q,w_1
    w_2) = t$.

    Now, consider $s_1 \defined \delta(t, w_1)$. Assume by contradiction that
    $s_0$ is not comparable with $s_1$ for the prefix relation. Then, consider
    the smallest $v$ for the prefix relation such that $\delta(t, v)$ is a
    strict prefix of $s_0$. It must exist, because otherwise the two are always
    comparable. Since $t \equiv_L q$, we know that $tv \equiv_L qv$, but then,
    this contradicts the minimality of $u$.

    We have proven that $s_0$ and $s_1$ are comparable, hence they
    are equal.
    Finally, we have proven that $\delta(q, w_1) = s_0$,
    $\delta(s_0, w_2) = t$, and $\delta(s_0, w_2) = \delta(t, w_1w_2) = q$ which is absurd.

    As a consequence $t$ and $q$ were comparable for the prefix relation,
    hence equal, and therefore $\delta(q, w) = q$.
\end{proof}

We do not know if \kl{commutativity} is decidable for more powerful models of
computation, and conjecture that it is decidable for \kl{polyregular functions}
in general.

\begin{conjecture}
    Let $f \in \Poly$. One can decide if $f$ is \kl{commutative}.
\end{conjecture}


The goal is to prove \cref{decide-n-poly-general:thm}.
To that end, we will use factorisation forests.
\begin{definition}
    Forests of depth $d$ by induction.
\end{definition}


\begin{remark}
    Place the nested higman embedding on the forests, it is a well-quasi-ordering.
\end{remark}

\begin{definition}
    Counting functions. $\vcount{q}$ where $q$ is a pattern.
\end{definition}

\begin{definition}
    Divisibility of patterns.
\end{definition}

\begin{definition}
    Forest iteration, where $q$ is a pattern.
\end{definition}

\begin{theorem}[Simon, restated in ]
    For every $f \in \ZPoly[k]$,
    there exists a computable function $h \colon \Sigma^* \to F_d(M)$,
    and a function $g \colon F_d(M) \to \Rel$ that is a counting function
    such that.
\end{theorem}

\textbf{TODO: domains should have a good shape, i.e.,
    intersections of sentences of the shape
    this pattern has at most "X" matches, and should be
    downwards closed}.

\textbf{TODO: problem, there is a problem, it is not because
    the number of matches is unbounded, that we can
    iterate the shape itself no?}

\begin{lemma}
    A function $g \colon F_d(M) \to \Rel$ is $\Nat$-polyregular
    over a domain $D$ if and only if for every 
    pattern iteration, the function obtained is
    $\Nat$-polyregular (commutative).
\end{lemma}
\begin{proof}
    By induction on the domain $D$, and on the divisibility ordering
    of patterns.
    Base case, for all pattern iteration, the value of $g$ is bounded.
    Then, $g$ has finitely many outputs, and they are all in $\Nat$,
    we have concluded.

    Let $q_i$ be a maximal pattern of $g$. If $q_i$ cannot be iterated in $D$,
    then the value of $q_i$ is bounded by some constant, and we can rewrite it
    as counting "full" patterns?

    Otherwise, $q_i$ can be iterated, and therefore we can
    pump to prove that its coefficient must be strictly positive.
    Then, using some derivation magic, we can recurse.
\end{proof}


\begin{theorem}
    \label{decide-n-poly-general:thm}
    Let $f \in \ZPoly[k]$, the following are equivalent:
    \begin{enumerate}
        \item $f \in \NPoly$;
        \item $f \in \NPoly[k]$;
        \item for all $h$ commutative polyregular function,
            $f \circ h$ in $\NPoly$
        \item for all pattern iteration,
            $f(pattern)$ is a \kl{$\Nat$-rational polynomial}.
    \end{enumerate}
    Furthermore, the properties are decidable.
\end{theorem}
\begin{proof}
    (1) implies (2) is okay, because of generic results.
    (2) implies (3) implies (4) is completely fine.
    Now, let us prove that (4) implies $1$.
\end{proof}



\begin{conjecture}
    Let $q,k \in \Nat$.
    Associate to a word $w$ the number of representatives
    of every $\MSO(q,k)$ type. 
    The image of this map is a semilinear set.
    In particular, it has a simple basis.
\end{conjecture}

\begin{conjecture}
    Let $f \in \ZPoly[k]$
    be \kl{combinatorial}.
    Then, $f$ is non-negative and for every pair
    $(u,w) \in \Sigma^*$,
    the sequence $\seqof{u w^n}{n \in \Nat}$
    is \kl{good}.
\end{conjecture}
\begin{proof}
    By induction on $k$.
\end{proof}

\begin{conjecture}
    Let $f \in \ZPoly[k]$
    be a non-negative function such that for every
    $(u,w) \in \Sigma^*$,
    the sequence $\seqof{u w^n}{n \in \Nat}$
    is \kl{good}.
    Then, $f$ belongs to $\NPoly[k]$.
\end{conjecture}
\begin{proof}
    By induction on $k$.
    For $k = 0$, non-negative is enough.
    To go beyond, we

\end{proof}


\begin{fact}[Folklore about regular languages]
    \label{regular:fact}
    The language $\setof{ w \in \Sigma}{ \card[a]{w} = \card[b]{w}}$
    is not regular, whenever $a,b \in \Sigma$.
    Regular languages are closed under intersection.
\end{fact}
