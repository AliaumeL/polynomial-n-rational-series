%! TeX program = xelatex
%! lang = en-US
\section{Preliminaries}
\label{preliminaries:sec}

\AP In the rest of this paper, $\Rel$ (resp. $\Nat$) denotes the set of
integers (resp. nonnegative integers). The capital letters $\Sigma,\Gamma$
denotes fixed alphabets, i.e. a finite set of letters, and $\Sigma^*, \Gamma^*$
(resp. $\Sigma^+, \Gamma^+$) are the set of words (resp. non-empty words) over
$\Sigma, \Gamma$. The empty word is written $\varepsilon \in \Sigma^*$. When $w
\in \Sigma^*$ and $a \in \Sigma$, we let $\card{w} \in \Nat$ be the length of
$w$, and $\card[a]{w}$ be the number of occurrences of $a$ in $w$. We assume
that the reader is familiar with the basics of automata theory, in particular
the notions of monoid morphisms, idempotents in monoids, monadic second-order
($\MSO$) logic and first-order ($\FO$) logic over finite words (see e.g.
\cite{thomas1997languages}). 

\AP In order to build functions in $\NPoly$, the following constructions will
be useful. For every language $L \subseteq \Sigma^*$ we define $\ind{L} \colon
\Sigma^* \to \set{0,1}$ as the indicator function of $L$. Given an $\MSO$
formula with first-order free variables $\varphi(\vec{x})$, we define
$\vcount{\varphi(\vec{x})}$ as the function from $\Sigma^*$ to $\Nat$ that maps
a word $w$ to the number of assignments $\nu \colon \vec{x} \to w$, such that
$w, \nu \models \varphi(\vec{x})$. If $X$ is a set of functions from $\Sigma^*$
to $\Rel$, and a subset $\mathbb{S}$ of $\Rel$, we define
$\Span{\mathbb{S}}(X)$ as the smallest subset of functions from $\Sigma^* \to
\Rel$ containing $X$ and closed under (finite) sums and multiplication with $s
\in \mathbb{S}$.

\subsection{Polyregular Functions}

\AP All functions in this paper have output in $\Nat$ or $\Rel$, hence, we
avoid the definition of \kl{polyregular functions} in full generality. The
following \cref{nat-rel-poly:def} is one of the equivalent definitions of
\cite{LOPEZ23b}, and is similar in shape to the \emph{finite counting automata}
introduced by \textcite{schutzenberger1962}. Let us recall that a monoid $M$ is
\intro(monoid){aperiodic} whenever there exists $n \in \Nat$ such that for all
$x \in M$, $x^{n+1} = x^n$.

\begin{definition}[$\Rel$-polyregular functions {\cite{LOPEZ23b}}]
    \label{nat-rel-poly:def}
    Let $M$ be a finite monoid, $\mu \colon \Sigma^* \to M$
    be a morphism, $k \in \Nat$, and 
    $\pi \colon M^k \to \Rel$ be a production function.
    The \intro{$\Rel$-polyregular function}
    $\pi^\dagger \colon \Sigma^* \to \Rel$
    is computed as follows:
    \begin{equation*}
        \pi^\dagger (w) \defined
        \sum_{w = u_1 \cdots u_k} \pi(\mu(u_1), \dots, \mu(u_k))
        \quad .
    \end{equation*}
    When $\pi$ has co-domain $\Nat$, the function $\pi^\dagger$
    is called \intro{$\Nat$-polyregular}.
    When the monoid $M$ is \kl(monoid){aperiodic}
    then
    the function $f$ is \intro{star-free $\Rel$-polyregular}
    (resp. \intro{star-free $\Nat$-polyregular}).
\end{definition}


\begin{example}
    \label{size-of-word-nsf:ex}
    The map $f \colon w \mapsto \card{w} + 1$
    belongs to $\NSF$.
\end{example}


\AP Let us briefly recall in the following lemma alternative characterizations
of $\NPoly$ (resp. $\ZPoly$), some of which will be helpful in the upcoming
analysis of their \kl{commutative} counterpart, and others that provide
a nicer syntax to construct examples. These characterizations are known, and
can be found in \cite{gaetanphd,LOPEZ23b}.

\begin{lemma}
    \label{polynomial-rational-polyreg:fact}
    Let $f \in \NRat$ (resp. $f \in \ZRat$), then
    the following are equivalent:
    \begin{enumerate}
        \item $f \in \NPoly$ (resp. $\ZPoly$);
        \item $f$ is a \kl{polyregular function} with output
            in $\set{1}^*$,
            postcomposed with $\polysum$
            (resp. with output in $\set{-1,+1}^*$);
        \item $f$ has \kl{polynomial growth};
        \item \label{npoly-counting-mso:item} $f$ belongs to
            $\Span{\mathbb{S}}(\setof{\vcount{\varphi}}{\varphi(\vec{x}) \in \MSO})$
            with $\mathbb{S} = \Nat$
            (resp. $\mathbb{S} = \Rel$).
    \end{enumerate}
\end{lemma}

Similar characterizations can be obtained for $\NSF$ and $\ZSF$.

\begin{lemma}
    Let $f \in \NPoly$ (resp. $f \in \ZPoly$), then
    the following are equivalent:
    \begin{enumerate}
        \item $f \in \NSF$ (resp. $\ZSF$);
        \item $f$ is a \kl{star-free polyregular function} with output
            in $\set{1}^*$,
            postcomposed with $\polysum$
            (resp. with output in $\set{-1,+1}^*$);
        \item $f$ belongs to
            $\Span{\mathbb{S}}(\setof{\vcount{\varphi}}{\varphi(\vec{x}) \in \FO})$
            with $\mathbb{S} = \Nat$
            (resp. $\mathbb{S} = \Rel$).
    \end{enumerate}
\end{lemma}

\begin{example}
    \label{regular-language:ex}
    Let $\Sigma$ be a finite alphabet, and
    $L \subseteq \Sigma^*$. Then,
    $L$ is a regular language if and only if
    $\ind{L} \colon \Sigma^* \to \set{0,1}$ is a
    \kl{$\Nat$-polyregular function}.
    Furthermore, $L$ is a star-free regular language
    if and only if $\ind{L}$ is a
    \kl{star-free $\Nat$-polyregular function}.
\end{example}


\AP Inside $\ZPoly$ there is an infinite hierarchy of classes, defined by
limiting the maximal number of free variables used to construct the function as
a sum of counting formulas (\cref{npoly-counting-mso:item}). We write
$\ZPoly[k]$ (resp. $\NPoly[k]$, $\ZSF[k]$, $\NSF[k]$) for the functions in
$\ZPoly$ (resp. $\NPoly$, $\ZSF$, $\NSF$) that can be constructed using at most
$k$ free variables. It has been proven in
\cite{LOPEZ23b,bojanczyk2022transducers} that the classes $\ZPoly[k]$ (resp.
$\NPoly[k]$, $\ZSF[k]$, $\NSF[k]$) are characterized by the \kl{growth rate},
that is, $f \in \ZPoly[k]$ if and only if $f \in \ZPoly$ and $\growth{f}(n) =
\bigO(n^k)$, and similarly for the other classes.

\subsection{Commutative Input}

\AP Because this paper focuses on functions that are commutative both in the
input and the output, let us introduce precisely what it means and how it
relates to other functions from $\Nat^k \to \Nat$. For that, let $\Sigma$ be a
finite alphabet. We define $\commute \colon \Sigma^* \to \Nat^\Sigma$ for the
map that counts occurrences of every letter in the input word, namely: $
\commute[w] \defined (a \mapsto \card[a]{w})$. Let $X$ be a set. A function $f
\colon \Sigma^* \to X$ is \intro{commutative} whenever for all $u,v \in
\Sigma^*$, $f(uv) = f(vu)$. Equivalently, it is \reintro{commutative} whenever
there exists a map $g \colon \Nat^\Sigma \to X$ such that $g \circ \commute =
f$.

To ensure that we are working inside a decidable subclass of \kl{$\Rel$-rational series}
let us state that commutativity is decidable. The proof is straightforward in the case
of \kl{$\Rel$-polyregular functions}, and more involved for general \kl{$\Rel$-rational series}.

\begin{lemma}
    \label{decidable-commutative-poly:lemma}
    \label{decidable-commutative-rat:lemma}
    Let $f \in \ZRat$. One can decide if 
    $f$
    is \kl{commutative}.
\end{lemma}

Let us briefly remark that the characterizations of subclasses of
\kl{polyregular functions} that are obtained in practice can be obtained by
pre-composition with a \kl{commutative} \kl{polyregular function}. While the
two following
\cref{pre-compose-growth-commut:lemma,pre-compose-sf-commut:lemma} do not
provide simpler proofs, they suggest the central position of \kl{commutative}
\kl{star-free polyregular functions} as \emph{test functions} for various
properties (growth rate, aperiodicity).

\begin{lemma}
    \label{pre-compose-growth-commut:lemma}
    Let $f \in \ZRat$, and $k \in \Nat$,
    the following are equivalent:
    \begin{enumerate}
        \item $f \in \ZPoly[k]$,
        \item For every \kl{commutative} \kl{star-free polyregular function} $h$
            of \kl{growth rate} $l \in \Nat$,
            $(f \circ h) \in \ZPoly[k+l-1]$.
    \end{enumerate}
\end{lemma}


\begin{lemma}
    \label{pre-compose-sf-commut:lemma}
    Let $f \in \ZPoly$.
    The following are equivalent:
    \begin{enumerate}
        \item $f \in \ZSF$,
        \item For every \kl{commutative} \kl{star-free polyregular function} $h$,
            $(f \circ h) \in \ZSF$.
    \end{enumerate}
\end{lemma}

\AP A function $g \colon \Nat^n \to \Rel$ is \intro{represented} by a function
$f \colon \Sigma^* \to \Rel$ if there exists a map $\eta \colon \set{1, \dots,
n} \to \Sigma$ such that $g \circ (v \mapsto \seqof{v_{\eta(k)}}{1 \leq k \leq
n}) \circ \commute = f$. A key family of functions will be \kl{represented} by
\kl{$\Rel$-polyregular functions}, namely polynomials with multiple indeterminates.

\subsection{Polynomials} \AP All polynomials considered in this paper have
coefficients in $\Rel$ unless explicitly stated otherwise. A polynomial $P \in
\Rel[X_1, \dots, X_n]$ is a \intro{$\Nat$-rational polynomial} if it is
\kl{represented} by a \kl{$\Nat$-polyregular function}. The analogue notion of
\intro{$\Rel$-rational polynomials} is not of particular interest, since every
polynomial $P$ is \kl{represented} by a \kl{$\Rel$-polyregular function}.

\begin{example}
    \label{negative-not-nrat:ex}
    The polynomials $X$, and $X^2 + 3$ are \kl{$\Nat$-rational polynomials},
    but $- X$ is a \kl{$\Rel$-rational polynomial} that is 
    not a \kl{$\Nat$-rational polynomial}.
\end{example}

\AP A polynomial $P \in \Rel[X_1, \dots, X_k]$ is \intro{non-negative} when for
all non-negative integer inputs $n_1, \dots, n_k \geq 0$, the output  $P(n_1,
\dots, n_k)$ of the polynomial is non-negative. Beware that we do not consider
negative values as input, as the numbers $n_i$ will ultimately count the number
of occurrences of a letter in a word. As an example, the polynomial $(X - Y)^2$
is \kl{non-negative}, and so is the polynomial $X^3$, but the polynomial $X^2 -
2X$ is not.

All \kl{$\Nat$-rational polynomials} are \kl{non-negative}, but the converse does
not hold,
as the following example illustrates. Note that the proof scheme of
this example will be at the core of \cref{thm:counter-example}, and leverages
a key property of $\NRat$ recalled hereafter.

\begin{fact}
    \label{pre-image-regular:fact}
    The pre-image of a regular language by a \kl{$\Nat$-rational series}
    is a regular language. 
\end{fact}

\begin{example}
    Let $P(X, Y) \defined (X - Y)^2$.
    Then $P$ is
    is \kl{non-negative}, but is
    not a \kl{$\Nat$-rational polynomial}.
\end{example}
\begin{proof}
    Assume by contradiction that
    $f \in \NPoly$ \kl{represents} $f$ over the alphabet $\Sigma \defined \set{a,b}$.
    Then, $f^{-1}(\set{0})$ is a regular language
    (\cref{pre-image-regular:fact}),
    but $S^{-1}(\set{0}) = \setof{ w \in \Sigma }{ \card[a]{w} = \card[b]{w} }$
    is not.
\end{proof}


\AP Let us now give some vocabulary on polynomials with multiple indeterminate
over $\Rel$. A \intro{monomial} is a product of indeterminates and integers.
For instance, $XY$ is a \kl{monomial}, $3 X$ is a \kl{monomial}, $-Y$ is a
\kl{monomial}, but $X + Y$ or $2X^2 + XY$ are not. We write $\Monomials[X_1,
\dots, X_n]$ for the set of \kl{monomials} over these indeterminates.
Every polynomial $P \in \Rel[X_1, \dots, X_n]$ decomposes uniquely
into a sum of \kl{monomials}.

\AP A \kl{monomial} $S$ \intro{divides} a \kl{monomial} $T$, when $S$ divides
$T$ seen as polynomials in $\Rat$. For instance, $2X$ \kl{divides} $XY$, $-YZ$
\kl{divides} $X^2 Y Z^3$, and $Y$ does not \kl{divide} $X$. In the
decomposition of $P \in \Rel[X_1, \dots, X_k]$, a \kl{monomial} is a
\intro{maximal monomial} if it is a maximal element for the \kl{divisibility
ordering} of \kl{monomials}. In the polynomial $P(X,Y) \defined X^2 - 2XY + X^2
+ X + Y$, the set of \reintro{maximal monomials}, written
$\MaximalMonomials(P)$, is $\set{X^2,  -2 XY,  X^2}$. A \kl{monomial} has a
\intro{non-negative coefficient} if its multiplicative constant belongs to
$\Nat$, or equivalently, if it is \kl{non-negative} as a polynomial. In the
polynomial $P(X,Y) \defined (X - Y)^2$, the \kl{non-negative} \kl{monomials}
are $X^2$ and $Y^2$.
