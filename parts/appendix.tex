%! TeX program = xelatex
%! lang = en-US
\section{Proofs of section \ref{preliminaries:sec}}

\begin{proofof}[non-canonical-transd:ex]
    Let us prove that the transducer of
    \cref{non-canonical-transd:fig:counter-free}
    computes $f$.
    We prove by induction on $w$
    that $A(q_0, w) = f(w)$,
    and that $A(q_1, w) = f(aw)$.
    To that end, let us first remark that $f(\varepsilon) = 1$,
    and $f(au) = \card{u}$.
    
    When $w = \varepsilon$, $A(q_0, \varepsilon) = F(\varepsilon) = 1 = f(\varepsilon)$.
    Similarly, $A(q_1, \varepsilon) = F(q_1) = 0 = f(a)$.

    Assume that $w = au$. Then:
    \begin{align*}
        A(q_0, w) = A(q_0, au) &= \lambda(q_0, a)(u) + A(q_1, u) \\ 
                               &= 0 + A(q_1,u) \\
                               &= f(au) & \text{by induction hypothesis} \\
                               &= f(w) 
    \end{align*}
    Similarly,
    \begin{align*}
        A(q_1, w) = A(q_1, au) &= \lambda(q_1, a)(u) + A(q_1, u) \\ 
                               &= 1 + A(q_1,u) \\
                               &= 1 + f(au) & \text{by induction hypothesis} \\
                               &= 1 + \card{u} \\
                               &= \card{au} \\
                               &= f(aau) \\
    \end{align*}

    The proof for the other automaton is similar. The
    key ingredient in the induction hypothesis is that if $\card{u} \geq 1$, then:
    $f(au) - f(u) = 1$ and otherwise $f(a) - f(\varepsilon) = -1$.
    Hence, $f(au) - f(u) = 1 - 2 \times \ind{\card{u} = 0} = \lambda(q_1, a)(u)$.
\end{proofof}


\begin{proof}[Proof of \cref{decidable-commutative-poly:lemma}, in the polyregular case]
    Let $\Sigma$ be a finite alphabet, endowed with a
    total ordering over its letters,
    and let $f \colon \Sigma^* \to \Rel$ be a
    \kl{$\Rel$-polyregular function}.
    The map $\polysort \colon \Sigma^* \to \Sigma^*$
    that sorts the letters in the input word $w$ according
    to the chosen ordering is a \kl{polyregular function}
    \cite[Proposition II.12]{CDTL23}.
    As a consequence,
    $(f \circ \polysort) \in \ZPoly$.
    Finally, $f$ is \kl{commutative} if and only
    if $f = f \circ \polysort$, which is decidable
    in the case of $\ZPoly$
    \cite[Corollary II.24]{CDTL23}, and more generally in the case 
    of $\ZRat$ \cite[Corollary 3.6 p 38]{BERE10}.
\end{proof}

\begin{proof}[Proof of \cref{decidable-commutative-rat:lemma} in the general case]
    Because $f$ is a \kl{$\Rel$-rational series},
    there exists a $n \in \Nat$,
    vectors $v_1$ and $v_2$,
    and $n$ by $n$ integer matrices $\seqof{M_a}{a \in \Sigma}$,
    such that
    \begin{equation*}
        \forall w \in \Sigma^*,
        f(w) = {}^t v_1 \left(\prod_{i = 1}^{|w|} M_{w_i}\right) v_2 \quad .
    \end{equation*}
    To simplify notations, 
    let us write $M_w \defined \prod_{i = 1}^{|w|} M_{w_i}$,
    and 
    $S \defined \setof{M_w}{w \in \Sigma^+}$ be the
    semigroup generated by $\seqof{M_a}{a \in \Sigma}$.

    The function $f$ is \kl{commutative} if and only if for all $u,v \in
    \Sigma^+$, ${}^t v_1 (M_u M_v  - M_v M_u) v_2 = 0$. The above is a
    polynomial equation involving the coefficients of $M_u$ and $M_v$.
    Let us compute $\overline{S \times S}$ the Zariski closure of $S \times S$.
    The above polynomial vanishes over $S \times S$ if and only
    if it belongs to the Zariski closure, which is decidable
    \cite[\textbf{WHERE}]{HOPW18}.
\end{proof}

\begin{proof}[A simpler proof of \cref{decidable-commutative-rat:lemma} in the general case]
    Remark that the group of permutations of $\set{1, \dots, n}$ is generated by
    the cycle $c \defined (n,1, \dots, n-1)$ and the transposition $t \defined (1, 2)$.
    As a consequence, a function $f$ is commutative if and only if
    $f \circ c = f = f \circ t$.
    When $f$ is a rational series,
    $f \circ c$ and $f \circ t$ are both rational series that can be
    effectively computed from $f$, and since equivalence
    of rational series is decidable 
    \cite[\textbf{WHERE}]{BERE10}
    we have obtained a decision procedure.
\end{proof}
    

\section{Proofs of section \ref{polynomials:sec}}


\begin{proofof}[n-poly-n-poly:example]
    The polynomials of $\Nat[\vec{X}]$
    are obtained from basic functions (constant in $\Nat$,
    $X_i$ for some $1 \leq i \leq n$)
    by products and sums. Because the basic functions are
    \kl{represented} by \kl{star-free $\Nat$-polyregular} functions,
    that are closed under these operations, we conclude.
\end{proofof}

\begin{proofof}[negative-not-nrat:ex]
    The function $w \mapsto |w|$ is a \kl{$\Nat$-polyregular function}.
    Thus, 
    $P(X) \defined X$ is
    a \kl{$\Nat$-rational polynomial}. Similarly,
    $w \mapsto |w|^2 + 3$ is a \kl{$\Nat$-polyregular function},
    showing that $Q(X) \defined X^2 + 3$
    is a \kl{$\Nat$-rational polynomial}.

    Remark that $P = (X-1)^2 + 1$. Let $f  \colon \Sigma^* \to \Nat$
    that maps $aw \mapsto |w|^2$, and $\varepsilon \mapsto 0$.
    It is clear that $f \in \NPoly$, and that 
    $P$ is \kl{represented} by
    $\ind{|w| \geq 1} \times f + \ind{|w| = 0} + 1$.

    Finally, 
    $T(X) \defined - X$ cannot be 
    a \kl{$\Nat$-rational polynomial} as \kl{$\Nat$-polyregular functions}
    are non-negative.
\end{proofof}








As one would expect, the \kl{discrete derivatives} are linear operations on
polynomials, that commute with \kl{translation operators}. However, the
\kl{translation operators} do not perfectly commute with partial applications
$\restr{\cdot}{\nu}$.

\begin{fact}
    \label{discrete-deriv-linear:fact}
    For all tuples $\vec{X}$ of indeterminates,
    for all $K \in \Nat$, $L \in \Rel$, for all partial functions
    $\nu \colon \vec{X} \topartial \Nat$:
    \begin{enumerate}
        \item The maps $\translate{K} \colon \Rel[\vec{X}] \to \Rel[\vec{X}]$,
        $\Diff{K}{ \cdot } \colon \Rel[\vec{X}] \to \Rel[\vec{X}]$,
        and
        $\restr{\cdot}{\nu} \colon \Rel[\vec{X}] \to \Rel[\vec{X}]$
            are linear operators,
        \item $\Diff{K}{ \cdot } \circ \translate{L}
            = \translate{L} \circ \Diff{K}{\cdot}$,
        \item $\restr{\cdot}{\nu} \circ \translate{L}
            = \translate{L} \circ \restr{\cdot}{\translate{L}(\nu)}$.
    \end{enumerate}
\end{fact}

\AP Let us now introduce the ordering over which the induction of
\cref{lem:correct-to-n-rat} is built. Recall that $\MaximalMonomials(P)$ is the
set of \kl{maximal monomials} of $P$, hence belongs to $\Pfin(\Monomials)$. We
order \kl{monomials} with the \kl{divisibility ordering}, making $\Monomials$ a
\kl{well-quasi-ordering} that is isomorphic (once quotiented to be a partial
ordering) to $\Nat^k$ with the product ordering \cite[Dickson’s Lemma]{SCSC12}.
We endow $\Pfin(\Monomials)$ with the \intro{Hoare ordering}, that is, $S_1
\hoareleq S_2$ whenever for all \kl{monomials} $M_1 \in S_1$, there exists a
monomial $M_2 \in S_2$, such that $M_1$ \kl{divides} $M_2$. The set
$(\Pfin(\Monomials), \hoareleq)$ remains a \kl{well-quasi-ordering}, and is in
particular well-founded \cite[Hoare quasi-ordering]{SCSC12}.

\begin{fact}
    \label{maxi-monomials-submodular:fact}
    Let $P, Q$ be two polynomials.
    Then, $\MaximalMonomials(P+Q) \hoareleq \MaximalMonomials(P)
    \cup \MaximalMonomials(Q)$.
\end{fact}


\begin{fact}
    \label{translation-maximal:fact}
    For all $P \in \Rel[\vec{X}]$, and $K \in \Nat$,
    \begin{equation*}
        \MaximalMonomials(P) = \MaximalMonomials(\translate{K}(P))
        \quad .
    \end{equation*}
\end{fact}

\textbf{TODO: fix this?}
\begin{fact}
    \label{derivation-monomials:fact}
    Let $K > 0$,
    and let $M,T$ be two \kl{monomials}, such that
    $T$ \kl{strictly divides} $M$.
    Then,
    every \kl{monomial} of $\Diff{K}{M}$ \kl{strictly divides} $M$,
    and 
    $T$ \kl{divides} some \kl{maximal monomial}
    of $\Diff{K}{M}$, which has a coefficient
    that is a multiple of $K$.
\end{fact}
\begin{proof}
    Let $M \defined X_1^{k_1} \cdots X_n^{k_n}$,
    where $k_1, \dots, k_n > 0$ and $n > 0$.
    Let us compute
    \begin{align*}
        \Diff{K}{M} &= \prod_{i = 1}^n X_i^{k_i} - \prod_{i = 1}^n (X_i - K)^{k_i} \\
                    &= \sum_{p = 1}^n \frac{K}{X_p - K} \prod_{i = 1}^n (X_i - K)^{k_i} 
    \end{align*}
    Therefore, 
    the \kl{maximal monomials} of $\Diff{K}{M}$
    are precisely
    of the form $K \frac{\prod_{i = 1}^n X_i^{k_i}}{X_p}$ for some $1 \leq p \leq i$,
    which \kl{strictly divides} $M$.
    Let $T$ be a \kl{monomial} that \kl{strictly divides} $M$,
    then, $T = \prod_{i = 1}^n X_i^{t_i}$, 
    for all $1 \leq i \leq n$, $t_i \leq k_i$,
    and there exists $1 \leq p \leq n$ such that $t_j < k_j$.
    In particular, $T$ \kl{divides}
    $K \frac{\prod_{i = 1}^n X_i^{k_i}}{X_p}$.
\end{proof}


\begin{lemma}
    \label{derivation-simplifies:lemma}
    For all $P \in \Rel[\vec{X}]$ that are non-constant,
    for all $K \in \Nat$,
    $\MaximalMonomials(\Diff{K}{P}) \hoarele
    \MaximalMonomials(P)$.
\end{lemma}
\begin{proof}
    Let $P \in \Rel[\vec{X}]$ and
    $K \in \Nat$.
    Leveraging 
    \cref{derivation-monomials:fact,discrete-deriv-linear:fact,maxi-monomials-submodular:fact}:
    \begin{align*}
        \MaximalMonomials\left(\Diff{K}{P}\right)
        &=
        \MaximalMonomials\left(\sum_{M \in \Monomials(P)} \Diff{K}{M}\right) \\
        &\hoareleq
        \bigcup_{M \in \Monomials(P)} 
        \MaximalMonomials(\Diff{K}{M}) \\
        &\hoarele
        \MaximalMonomials(P)
        & \text{ because } \deg(\Diff{K}{P}) < \deg(P)
    \end{align*}
    Which concludes the proof.
\end{proof}

\textbf{Redo the proof}.
\begin{proofof}[derivation-stabilises-correct:lem]
    If $P$ is constant, then $P_2 = 0$, and $\Diff{K}{P_1} = 0$,
    hence for $K = 0$, $Q \in \CorrectPoly$.

    Otherwise, let $\alpha$ be the maximal absolute value 
    of coefficients appearing in $P$,
    and $D$ be the maximal number of divisors for
    a monomial in $P$.
    We define $K \defined \alpha \times D + 1$.

    Let $\nu \colon \vec{X} \topartial \Nat$, we are going to prove that
    $\restr{Q}{\nu}$ has \kl{non-negative} \kl{maximal monomials}. To that end,
    let us consider $T$ such a maximal monomial, and let us write $T = \beta
    T_1$ so that $T_1$ has coefficient $1$ and $\beta \in \Rel$. Because we
    will need to normalize other monomials in this way, we define for the rest
    of the proof the function $\mathsf{unit}$ that maps a monomial to the
    monomial obtained by replacing its constant term by $1$ if the monomial is
    non-zero, and leaving the monomial unchanged otherwise.

    Let us write $\mathcal{D}_1$ to be the set of \kl{monomials} of
    $\Diff{K}{P_1}$ that are \kl{divided} by $T$. Similarly, let us write
    $\mathcal{D}_2$ for the set of monomials of $\translate{K}(P_2)$ that are
    \kl{divided} by $T$. Thanks to \cref{derivation-monomials:fact}, we know
    that every element of $\mathcal{D}_2$ divides some element in
    $\mathcal{D}_1$. We write $\mathcal{D}_2^M$ for the set of monomials $S \in
    \mathcal{D}_2$ such that $S$ \kl{divides} $M$.
    
    Now, remark that the coefficient $\beta$ is obtained as follows:
    \begin{align*}
        \beta &= \sum_{M \in \mathcal{D}_1} \restr{M / T_1}{\nu}
               + \sum_{M \in \mathcal{D}_2} \restr{M / T_1}{\nu} \\
              &\geq \sum_{M \in \mathcal{D}_1} \restr{M / T_1}{\nu}
              - \sum_{M \in \mathcal{D}_2} \left|\restr{M / T_1}{\nu}\right|
              \\
              &\geq
              \sum_{M \in \mathcal{D}_1}
              \left[
              \restr{M / T_1}{\nu}
              -
              \sum_{S \in \mathcal{D}_2^M}
              \left|\restr{S/T_1}{\nu}\right|
              \right]
              \\
              &\geq
              \sum_{M \in \mathcal{D}_1}
              \restr{\mathsf{unit}(M)/T_1}{\nu}
              \left[
              K
              - \alpha D
              \right]
              \\
              &\geq 0 \quad . \qedhere
    \end{align*}
\end{proofof}


\begin{proofof}[derivation-translation:lem]

    We will first prove the equivalence between \cref{d-t-transl:item} and
    \cref{d-t-correct:item} without keeping track of the constant $K$, and then
    notice that this $K$ is actually computable. This will simplify the reading
    process.

    We will first prove that \cref{d-t-transl:item} $\implies$
    \cref{d-t-correct:item}, for any choice of $K \in \Nat$. Indeed, let us
    consider some partial valuation $\nu \colon \vec{X} \topartial \Nat$. By
    assumption, $\translate{K}(\restr{P}{\nu}) \in \Nat[\vec{X}]$, and in
    particular conclude that \kl{maximal monomials} of
    $\translate{K}(\restr{P}{\nu})$ are exactly the \kl{maximal monomials} of
    $\restr{P}{\nu}$ thanks to \cref{translation-maximal:fact}, and are
    therefore \kl{non-negative}.

    Conversely, the implication \cref{d-t-correct:item} $\implies$
    \cref{d-t-transl:item} is proven by induction on $\MaximalMonomials(P)$. If
    $P$ is a constant polynomial, then $P = n$ for some $n \in \Nat$, and we
    conclude that $\translate{0}(P) \in \Nat[\vec{X}]$. Otherwise, $P = P_1 +
    P_2$ where $P_1$ is the sum of the \kl{maximal monomials} of $P$. Using
    \cref{derivation-stabilises-correct:lem}, there exists a computable $K \in
    \Nat$ such that $Q \defined \Diff{K}{P_1} + \translate{K}(P_2)$ belongs to
    $\CorrectPoly$. Since, $\MaximalMonomials(Q) \hoarele
    \MaximalMonomials(P)$, we conclude by induction hypothesis that there
    exists $L \in \Nat$ such that for every partial valuation $\nu \colon
    \vec{X} \topartial \Nat$, $\translate{L}(\restr{Q}{\nu}) \in
    \Nat[\vec{X}]$. Similarly, for all partial functions $\nu \colon \vec{X}
    \topartial \set{0, \dots, K}$ fixing at least one indeterminate of $P$,
    $\MaximalMonomials(\restr{P}{\nu}) \hoarele \MaximalMonomials(P)$, hence
    there exists $L_\nu \in \Nat$ such that $\translate{L_\nu}(\restr{P}{\nu})
    \in \Nat[\vec{X}]$. Let us define $L_m$ to be the maximum of $L$, and
    $L_\nu$ where $\nu$ ranges over partial functions described above.


    Let us prove that for all partial functions $\nu \colon \vec{X} \topartial
    \Nat$, the translation $\translate{L_m + K}(\restr{P}{\nu})$ belongs to
    $\Nat[\vec{X}]$. Without loss of generality, $\nu$ fixes only
    indeterminates that appear in $P$. If $\nu$ fixes at least one
    indeterminate $X_i$ to a value $\nu(X_i) = k \leq K$, then we can write
    $\nu = \mu [X_i = k]$, where $\mu$ does not fix the value of $X_i$. By
    construction, we know that $\translate{L_i}(\restr{\restr{P}{X_i =
    k}}{\mu})$ belongs to $\Nat[\vec{X}]$, and therefore that $\translate{K +
    L_m}(\restr{P}{\nu})$ does so too. The only case left is when all the
    variables appearing in $\nu$ are greater than $K$.
    In that case, $\nu = \translate{K}(\mu)$ for some partial 
    valuation $\mu$.
    In this case,
    $\translate{K}(\restr{P}{\translate{K}(\mu)}
    = \restr{\translate{K}(P)}{\mu}$
    thanks to 
    \cref{discrete-deriv-linear:fact}.
    Remark that by definition,
    $\translate{K}(P) = P_1 + Q$,
    hence that
    $\translate{K + L_m}(P) = \translate{L_m}(P_1) + \translate{L_m}(Q)$
    belongs to $\Nat[\vec{X}]$.
    Finally,
    we conclude that $\restr{\translate{K+L_m}(P)}{\mu}$
    belongs to $\Nat[\vec{X}]$
    because
    the latter is closed under partial applications.


    Now, remark that in the proof, we have computed $K$ recursively from $P$,
    and only applied partial functions using values below $K$. This not only
    shows that $K$ is computable from $P$, but also that
    \cref{d-t-transl-fin:item} and \cref{d-t-transl:item} are equivalent.

    For the effective decision procedure,
    given $P \in \Rel[\vec{X}]$,
    one applies \cref{derivation-translation:lem}
    to obtain a bound $K$, and then 
    computes $\translate{K}(\restr{P}{\nu})$ for all 
    partial valuations $\nu \colon \vec{X} \topartial \set{0, \dots, K}$.
    Then $P \in \CorrectPoly$ if and only if all those polynomials
    belong to $\Nat[\vec{X}]$, which is decidable.
\end{proofof}



\section{Proofs of section \ref{beyond-polynomials:sec}}

\begin{proofof}[decompose-polynomial:lem]
    Let us first write $f \in \ZPoly$ as a linear combination 
    $f = f_+ - f_-$ where both $f_+$ and $f_-$ are in $\NPoly$.

    We apply
    \cref{n-poly-combinatorics:lem} to compute the $\omega$ that works for both $f_+$ and $f_-$.
    Using this $\omega$,
    for any choice of
    $r \defined (r_1, \dots, r_n) \in \set{0, \dots, \omega - 1}$,
    there exists a polynomial $P_r \in \Rel[X_1, \dots, X_p]$
    such that $X_1, \dots, X_p \geq \omega$:
    \begin{equation*}
        f\left(
        a_1^{\omega X_1 + r_1} \cdots a_n ^{\omega X_n + r_n}\right) 
        = P_r(X_1, \dots, X_p) \quad .
    \end{equation*}
    To get the full family of polynomials needed requires
    just to only iterate subsets of letters, and fix the other ones
    to be below the threshold $\omega^2$.
\end{proofof}





\section{Proofs of section \ref{beyond-commutative:sec}}

\begin{remark}
    \label{good-residual-ordering:fact}
    Let $k \in \Nat$, and let $f \colon \Sigma^* \to \Nat$. Then,
    $(\resleq{f}{k})$ is a quasi-ordering, satisfying the following
    extra properties:
    \begin{enumerate}
        \item For all $u,v,w \in \Sigma^*$, $u \resleq{f}{k} v$
            implies $uw \resleq{f}{k} vw$,
        \item If $u \resleq{f}{k} v$ and $v \resleq{f}{k} u$,
            then $\app{f}{u} = \app{f}{v}$.
    \end{enumerate}
\end{remark}


\begin{fact}
    \label{unique-res-transducer:fact}
    Let $f \colon \Sigma^* \to \Nat$ and $k \in \Nat$.
    Then $f$ has at most one \kl{$k$-residual transducer}.
\end{fact}
\begin{proof}
    Let $\aTransd_1$ and $\aTransd_2$ be two
    \kl{$k$-residual transducers} for $f$.
    The two initial states must be $\varepsilon$.
    Let us prove by induction on $u \in \Sigma^*$ that
    $\delta_1(\varepsilon, u) = \delta_2(\varepsilon, u)$
    and that $Q_1$ equals $Q_2$ over prefixes of $u$.
    This will prove that 
    $Q_1 = Q_2$, hence that $\aTransd_1 = \aTransd_2$.

    Let $u \in \Sigma^* \cap Q_1 \cap Q_2$ and $a \in \Sigma$, $v_1 \in Q_1$ be
    defined as $v \defined \delta_1(u,a)$, and $v_2 \defined \delta_2(u,a)$.
    Remark that by induction hypothesis, for all $v \prefle u$, $v \in Q_1 \cap
    Q_2$. If $\delta_1(u,a) = Q_1$, it means that for all $v \in Q_2$ such that
    $v \prefle ua$, we have $\neg( v \resleq{f}{k} ua )$. The only possible
    transition in $\aTransd_2$ is therefore $\delta_2(u,a) = ua$, and $ua \in
    Q_2$. Similarly, if $\delta_1(u,a) \prefleq u$, then $\delta_2(u,a) =
    \delta_1(u,a)$ by definition of $\delta_2$ as a maximum.
\end{proof}


\begin{fact}
    \label{q-o-prefix-cool:fact}
    Let $f \colon \Sigma^* \to \Nat$ and $k \in \Nat$.
    At each step of the \texttt{while loop}
    of \cref{residual:algo}, the sets
    $Q$ and $O$ are such that
    \begin{enumerate}
        \item $Q \cup O$ is a \kl{downwards closed} subset of 
            $\Sigma^*$ for $\prefleq$;
        \item elements in $O$ are pairwise incomparable
            for $\prefleq$, and are maximal
            for $\prefleq$ inside $Q \cup O$.
    \end{enumerate}
\end{fact}
\begin{proof}
    Let us write $Q_i$ and $O_i$ for the value of the variables
    $Q$ and $O$ at step $i$ of the \texttt{while loop}.
    We prove the desired property by induction on $i$.

    For $i=0$, the property is true because
    $Q_0 = \set{\varepsilon}$ and $O_0 = \setof{a}{a \in \Sigma}$.

    For $i+1$. Either the \texttt{if} branch was taken, in which case $Q_{i+1}
    \cup O_{i+1} = (Q_i \cup O_i) \setminus \set{u}$ for some $u \in O_i$. This
    set remains \kl{downwards closed}, and elements in $O_{i+1}$ remain maximal
    elements. 

    If the \texttt{else} branch was taken, then there exists $u \in O_i$ such
    that $Q_{i+1} = Q_i \cup \set{u}$ and $O_{i+1} = O_i \setminus \set{ u }
    \cup \setof{ ua }{ a \in \Sigma}$. We conclude that $Q_{i+1} \cup O_{i+1} =
    Q_i \cup O_i \cup \setof{ ua }{a \in \Sigma}$ continues to be \kl{downwards
    closed} for $\prefleq$. Let $v \in Q_{i+1} \cup O_{i+1}$ be such that $ua
    \prefleq v$ for some $a \in \Sigma$. Then $u \prefleq v$, and $u = v$ since
    $u$ was a maximal element. As a consequence, $ua$ is a maximal element for
    all $a \in \Sigma$. Assume by contradiction that $ua$ is comparable with
    some $v \in O_{i+1}$ with $ua \neq v$, it cannot be that $ua \prefleq v$ by
    the above argument, and if $v \prefleq ua$ with $v \neq ua$, then $v
    \prefleq u$ and $u = v$, which is absurd since $v \not \in O{i+1}$.
    We have concluded that $O_{i+1}$ continues to have pairwise incomparable
    elements.
\end{proof}


\begin{lemma}
    \label{correct-residual:lemma}
    If \cref{residual:algo} terminates on 
    an input $f \colon \Sigma^* \to \Nat$, $k \in \Nat$,
    then it computes the \kl{$k$-residual transducer} of $f$.
    \proofref{correct-residual:lemma}
\end{lemma}
\begin{proof}
    Because of \cref{q-o-prefix-cool:fact},
    we already know that $q_0 = \varepsilon$,
    $Q$ is a \kl{downwards closed} subset of $\Sigma^*$
    for $\prefleq$, 
    that every state of $Q$ is accessible from $q_0$.
    Notice that at every step,
    $\lambda(u,a)$ is defined as
    $\app{f}{ua} - \app{f}{\delta(u,a)}$.
    Finally, since $Q \cup O$ is a \kl{downwards closed} subset of $\Sigma^*$
    at every step,
    we have that at step $i$,
    for all $ua \in O_i$,
    $\setof{w \in Q}{w \prefleq ua} = \setof{w \in Q_i}{ w \prefleq ua}$,
    which proves that the maximum considered in the algorithm
    is indeed computing correctly.
\end{proof}

\begin{lemma}
    \label{wqo-implies-termination:lemma}
    Let $f \colon \Sigma^* \to \Nat$, and $k \in \Nat$ be such that
    every infinite, $\prefleq$-increasing sequence is \kl{good}
    in $(\Sigma^*, \resleq{f}{k})$
    (or equivalently, such that the relation $(\prefleq \Rightarrow \resleq{f}{k})$
    is \kl{well}).
    Then, \cref{residual:algo} terminates on the input $(f,k)$.
    \proofref{wqo-implies-termination:lemma}
\end{lemma}
\begin{proof}
    Assume towards a contradiction that
    \cref{residual:algo} does not terminate.
    Then, the \texttt{else} branch in the \texttt{while loop}
    must be taken infinitely often.
    This means that the set $Q$ of states grows arbitrarily large.

    Let us write $\seqof{Q_i}{i \in \Nat}$ for the set of states $Q$ at step
    $i$ of the execution of \cref{residual:algo}. Applying
    \cref{q-o-prefix-cool:fact}, we know that for all $i \in \Nat$, $Q_i$ is
    \kl{downwards closed} for $\prefleq$. Let us write $Q_\infty \defined
    \bigcup_{i \in \Nat} Q_i$. The set $Q_\infty$ is infinite, and is
    \kl{downwards closed} for $\prefleq$. As a consequence, it is an infinite
    tree with a finite branching (at most $\card{\Sigma}$), and has an infinite
    branch $\seqof{u_j}{j \in \Nat}$ thanks to König' s lemma.

    Let us prove that this infinite branch is a \kl{bad sequence} for the
    ordering $\resleq{f}{k}$.
    Let $j < p$, and assume by contradiction that $u_j \resleq{f}{k} u_p$. We
    know that $u_j \in Q_j$ and $u_p \in Q_p$. Then, at step $p-1$ of the
    algorithm, $u_j \in Q_{p-1}$, since $u_j \in Q_j \subseteq Q_{p-1}$.
    Because $u_j \prefleq u_p$ and $u_j \resleq{f}{k} u_p$,
    \cref{residual:algo} must take the \texttt{if} branch at step $p-1$. As a
    consequence, $u_p \not\in Q_{p}$, which is absurd.

    We have proven that the infinite branch is a \kl{bad sequence}
    for $\resleq{f}{k}$, which contradicts the assumption.
    Hence, \cref{residual:algo} must terminate.
\end{proof}



\begin{lemma}
    \label{n-poly-k-implies-wqo:lemma}
    Let $k \in \Nat$, and let $f \in \NPoly[k]$.
    Then, $(\Sigma^* \resleq{f}{k})$ is a \kl{well-quasi-ordering}.
\end{lemma}
\begin{proof}
    Because $f \in \NPoly[k]$, there exists
    a tuple $\vec{x}$ of first order free variables,
    $\MSO$ formulas $\seqof{\psi_i(\vec{x})}{1 \leq i \leq n}$,
    and positive coefficients $\seqof{m_i}{1 \leq i \leq n}$,
    such that
    $f = \sum_{i = 1}^n m_i \times \vcount{\varphi_i(\vec{x})}$
    \cite[Theorem 5.15]{DOUE23}.

    Let $q$ be the maximal quantifier rank of formulas $\seqof{\psi_i}{1 \leq i
    \leq n}$. To a word $u \in \Sigma^*$, we associate the vector $\MSO^q(u)$
    that maps an $\MSO$-type with $\ell \leq |\vec{x}|$ free variables to the
    number of realizations of this type in $u$.

    Let $u, v \in \Sigma^*$ such that $\MSO^q(u) \leq \MSO^q(v)$, which means
    that every $\MSO$ type (of quantifier rank $q$ and with at most $n$ free
    variables) has at least as many realizations in $v$ than it has in $u$.
    Remark that by the compositionality of $\MSO$ over words (for instance, see
    the Feferman-Vaught theorem \cite{FEVAU59,MAKOW04}), for all $\MSO^q$ types
    $t(\vec{x})$, there are finitely many $\MSO^q$ types $t_l^j(\vec{y_i}),
    t_r^j(\vec{z_i})$ with $\vec{x} = \vec{y_i} \uplus \vec{z_i}$
    for $1 \leq j \leq N_0$, such that for every
    tuple $\vec{a}$ of elements in a word $uv$, $\MSO^q(\vec{a} / uv) =
    t(\vec{x})$ if and only if there exists $1 \leq j \leq N_0$,
    such that $\vec{a} = \vec{b} \uplus \vec{c}$,
    $\MSO^q(\vec{b} / u) =
    t_l^j(\vec{y_i})$, and $\MSO^q(\vec{c} / v) = t_r^j(\vec{z_i})$.
    We write $t = t_l \odot t_r$ to signify
    that $\MSO^q(\vec{bc} / uv) = t$
    if and only if $\MSO^q(\vec{b}/u) = t_l$
    and $\MSO^q(\vec{c}/v) = t_r$.

    As a consequence, if $\MSO^q(u) \leq \MSO^q(v)$, then 
    for all $w \in \Sigma^*$:
    \begin{align*}
        & f(vw) - f(uw) \\
        &= 
        \sum_{i = 1}^n m_i
        \left[
            \vcount{\phi_i(\vec{x})} (vw) -
            \vcount{\phi_i(\vec{x})} (uw)
        \right] \\
        &= 
        \sum_{i = 1}^n
        m_i
            \sum_{\phi_i \in t(\vec{x})}
        \left[
            \vcount{t(\vec{x})}(vw)
            -
            \vcount{t(\vec{x})}(uw)
        \right] \\
        &= 
        \sum_{i = 1}^n
        m_i
        \sum_{1 \leq j \leq N_0}
        \sum_{\phi_i \in t_l^j(\vec{y}) \odot t_r^j(\vec{z})}
        \underbrace{
        \left[
            \vcount{t_r^j(\vec{y})}(v)
            -
            \vcount{t_r^j(\vec{y})}(u)
        \right] 
    }_{ \in \Nat }
            \times 
            \vcount{t_l^j(\vec{z})}(w)
    \end{align*}

    We have proven that if $\MSO^q(u) \leq \MSO^q(v)$, then $u \resleq{f}{k}
    v$. Recall that $\Nat^p$ is a \kl{well-quasi-ordering} when endowed with
    the product ordering, and therefore that $\setof{\MSO^q(u)}{u \in
    \Sigma^*}$ is a \kl{well-quasi-ordering}.

    Let $\seqof{u_i}{i \in \Nat}$ be an infinite sequence of $\Sigma^*$.
    Without loss of generality, one can assume that for all $i \neq j$, $u_i
    \equiv_k u_j$, i.e., that the difference $\app{f}{u_i} - \app{f}{u_j}$
    belongs to $\ZPoly[k-1]$, since the latter has finite index. Thanks to the
    above remarks, there exists $i < j$ such that $\MSO^q(u_i) \leq
    \MSO^q(u_j)$. As a consequence, $g \defined \app{f}{u_j} - \app{f}{u_i} \in
    \NPoly$, and therefore $g \in \NPoly[k-1]$. We have proven that there
    exists $i < j$ such that $u_i \resleq{f}{k} u_j$.
\end{proof}



\begin{proofof}[non-commutative-npoly:thm]
    \cref{n-poly-1-transd:item} implies \cref{n-poly-k:item} by
    definition. Then,
    \cref{n-poly-k:item} implies \cref{n-poly-wqo:item} by
    \cref{n-poly-k-implies-wqo:lemma}.
    The implication \cref{n-poly-wqo:item} $\Rightarrow$ \cref{n-poly-well:item}
    is obvious.
    Then, \cref{wqo-implies-termination:lemma} proves
    that \cref{n-poly-well:item} implies \cref{n-poly-residual:item}.
    Finally, because a \kl{$k$-residual transducer} is a \kl{$\NPoly[k-1]$-transducer},
    \cref{n-poly-residual:item} implies \cref{n-poly-1-transd:item}.
\end{proofof}

\begin{proofof}[aperiodic-iff-residual:lem]
    It is clear that $\NSF \subseteq \ZSF$, and known that if $f \in \ZSF$
    then it is \kl{ultimately polynomial}. Furthermore, if the \kl{$0$-residual
    transducer} of $f$ is \kl{counter-free}, then $f \in \NSF$
    by definition of $\NSF$.

    Assume that $f$ is \kl{ultimately polynomial}, let us prove that the
    \kl{$0$-residual transducer} of $f$ is \kl{counter-free}. 
    Note that because $f \in \NPoly[0]$,
    $u \resleq{f}{0} v$ if and only if $\app{f}{u} = \app{f}{v}$.
    In particular, in a \kl{$0$-residual transducer} of $f$,  two states that
    represent the same residual must be incomparable for the prefix relation.

    Let $(q,w^n)$ be
    a counter with $n \geq 1$. This means that $\delta(q, w^n) = q$ in the
    automaton, and implies that $q \resleq{f}{0} qw^n$, hence that $\app{f}{q}
    = \app{f}{qw^n}$. Because $f$ is \kl{ultimately polynomial},
    we know that $\app{f}{qw^n} = \app{f}{qw^{n+1}}$,
    hence that $\app{f}{qw} = \app{f}{q}$.

    Let us write $t \defined \delta(q,w) = \delta(q,w^{n+1})$. We know that
    $\app{f}{q} = \app{f}{t}$. Assume by contradiction that $t$ and $q$ are
    incomparable for the prefix relation. Let us split $w = w_1 w_2$ where
    $w_1$ is the shortest prefix of $w$ such that $s_0 \defined \delta(q,w_1)$
    is an ancestor of $q$ and of $t$ for the prefix relation, it must exist
    because $\delta(q,w_1 w_2) = t$.

    Now, consider $s_1 \defined \delta(t, w_1)$. Assume by contradiction that
    $s_0$ is not comparable with $s_1$ for the prefix relation. Then, consider
    the smallest prefix $v$ of $w_1$ such that $\delta(t, v)$ is a strict
    prefix of $s_0$. It must exist, otherwise $s_0$ is always a prefix of
    $s_1$. Because $\app{f}{t} = \app{f}{q}$, we conclude that $\app{f}{tv} =
    \app{f}{qv}$. However, this contradicts the minimality of $w_1$, since
    $\delta(t,v)$ is an ancestor of $q$ and $t$.

    We have proven that $s_0$ and $s_1$ are comparable, hence they are equal,
    since $\app{f}{s_1} = \app{f}{t w_1} = \app{f}{q w_1} = \app{f}{s_0}$.
    Finally, we have proven that $\delta(q, w_1) = s_0$, $\delta(s_0, w_2) =
    t$, and $\delta(s_0, w_2) = \delta(t, w_1w_2) = q$ which is absurd.
    As a consequence $t$ and $q$ were comparable for the prefix relation,
    hence equal, and therefore $\delta(q, w) = q$.
\end{proofof}





\begin{proofof}[sf-no-periods-on-sequences:lemma]
    Let $f \in \NSF[k]$, $q \in \Nat$, and 
    write $f = \sum_{i=1}^n m_i \times \vcount{\phi_i(\vec{x})}$, where
    $\phi_i \in \FO$ has quantifier rank at most $q$
    and $\card{\vec{x}} = k$
    \cite[Theorem 7.10]{DOUE23}.

    As in the proof of \cref{n-poly-k-implies-wqo:lemma}, we are going to
    assign a tuple of integers to a word $u \in \Sigma^*$ by counting the
    number of realizations of each $\FO^q$ type of at most $k$ variables in
    $u$. To that end, let us write $\FO^q(u)$ this vector.

    First, let us notice that it suffices to prove that for some $n \in \Nat$,
    $\FO^q(uw^n) \leq \FO^q(uw^{n+1})$ to conclude, since $\app{f}{uw^{n+1}} -
    \app{f}{uw^n}$ will be obtained as a positive combination of counting
    first-order types in the argument.

    Let $t$ be a first order type with at most $k$ free variables and
    quantifier rank at most $q$. The map $g_t \colon X \mapsto
    \vcount{t}(uw^X)$ is a \kl{commutative} \kl{star-free $\Nat$-polyregular
    function}. As a consequence, there exists $N_0$ and a polynomial $P \in
    \CorrectPoly$ such that for all $X \geq N_0$, $g_t(X) = P(X)$. Now, because
    $P \in \CorrectPoly$, there exists a $K \in \Nat$ such that
    $\translate{K}(\Diff{1}{P}) \in \Nat[X]$
    (\cref{derivation-translation:lem}), and in particular $g_t(X + N_0 + K+1)
    - g_t(X + N_0 + K) \in \Nat$, for all $X \geq 0$.

    Because there are finitely many non-equivalent $\FO^q$ types with at most 
    $k$ free variables, we can take the maximum of the $K$'s obtained for each 
    of those, and conclude.
\end{proofof}

\section{Proofs of section \ref{sec:ccl}}

\begin{proofof}[pre-compose-growth-commut:lemma]
    If $f \in \ZPoly[k]$, then 
    for every \kl{polyregular function} $g \in \Poly[\ell]$,
    $f \circ g \in \ZPoly[k \times \ell]$
    \cite{CDTL23}.

    Conversely, it was proven in \cite[Theorem III.3]{CDTL23}
    that $f \in \ZPoly[k]$ if and only if
    for all $\alpha_0, \cdots, \alpha_k$,
    for all $w_1, \dots, w_k$,
    we have 
    \begin{equation}
        \label{k-pumpable:eqn}
        f\left(
            \alpha_0 \prod_{i = 1}^k w_i^{X_i} \alpha_i
        \right)
        = \bigO( (X_1 + \cdots X_k)^{k} )
        \quad .
    \end{equation}
    Now, the \kl{commutative} \kl{star-free polyregular function} 
    $h \colon \set{1, \dots, k}^* \to \Sigma^*$ that maps
    a word $u$
    to $\alpha \prod_{i = 1}^k w_i^{\card[i]{u}}$
    has \kl{growth rate} $1$.
    Hence, 
    $f \circ h \in \ZPoly[k]$, 
    and we indeed conclude that 
    \cref{k-pumpable:eqn}
    holds, i.e. that $f \in \ZPoly[k]$.
\end{proofof}

\begin{proofof}[pre-compose-sf-commut:lemma]
    If $f \in \ZSF$, then for all $h \in \SF$,
    $f \circ h \in \ZSF$, and \emph{a fortiori}
    for \kl{commutative} functions $h$.

    Conversely, assume that $f \circ h \in \ZSF$
    for all \kl{commutative} functions $h \in \SF$.
    Using \cite[Theorem V.13]{CDTL23},
    to conclude that $f \in \ZSF$,
    it suffices to prove that
    for all $\alpha_0, \cdots, \alpha_k \in \Sigma^*$,
    for all $w_1, \dots, w_k \in \Sigma^*$,
    there exists a polynomial $P \in \Rel[X_1, \dots,X_k]$
    and a constant $N_0 \in \Nat$,
    such that if $X_1, \dots, X_k \geq N_0$:
    \begin{equation}
        \label{ultimate-polynomial:eqn}
        f\left(
            \alpha_0 \prod_{i = 1}^k w_i^{X_i} \alpha_i
        \right)
        = P(X_1, \dots, X_k)
        \quad .
    \end{equation}
    Let us consider
    the \kl{commutative} \kl{star-free polyregular function}
    $h \colon \set{1, \dots, k}^* \to \Sigma^*$ that maps
    a word $u$
    to $\alpha \prod_{i = 1}^k w_i^{\card[i]{u}}$.
    We know that
    $f \circ h \in \ZSF$, hence, that 
    there exists $Q \in \Rel[X_1, \dots, X_n]$
    and $M_0 \in \Nat$,
    such that for all $X_1, \dots, X_n \geq N_0$,
    $f \circ h( \prod_{i = 1}^k \underline{i}^{X_i}) = Q(X_1, \dots, X_n)$.
    In particular,
    we can take $N_0 = M_0$, and $P = Q$ to conclude that
    \cref{ultimate-polynomial:eqn} holds, hence, that
    $f \in \ZSF$.
\end{proofof}


\begin{proofof}[z-poly-commutative-encoding:remark]
    We are going to prove that if $f \in \ZPoly[k]$ is polyblind, 
    then the \cref{z-poly-commutative-encoding:conj} holds when allowing 
    for non polyregular functions $\mathsf{enc}$ and $\mathsf{dec}$.

    Let us consider $f \in \ZPoly[k]$ that is polyblind.
    Using \cite[Theorem 6.12]{DOUE23},
    we know that there exists a family of $\MSO$ formulas
    $\seqof{\psi_{i,j}(x)}{1 \leq i,j \leq n}$,
    and coefficients $\seqof{z_i}{1 \leq i \leq n}$,
    such that:
    \begin{equation*}
        f = \sum_{i = 1}^n z_i \times \prod_{j = 1}^n \vcount{\psi_{ij}(x)}
        \quad .
    \end{equation*}

    Let us now consider a monoid $M$ that recognizes all formulas $\psi_{ij}$
    for $1 \leq i,j \leq n$ with a morphism $\mu \colon \Sigma^* \to M$. Let us
    consider the map $\mathsf{t} \colon \Sigma^* \to (M^3)^*$, that associates
    to a word $w \in \Sigma^*$ the word $\mathsf{t}(w) \defined \prod_{i =
    1}^{|w|} ( \mu(w_{< i}), \mu(w_i), \mu(w_{> i}))$. That is, to every letter
    one associates its left and right context in the monoid.


    Let us define $\mathsf{s} \colon \Sigma^* \to (\Nat)^{M^3}$
    by letting $\mathsf{s}(w)$ be the Parikh image of $\mathsf{t}$, that is,
    counting the number of occurrences of every letter.
    It is clear how to define the polyregular function $g \colon (\Nat)^{M^3} \to \Rel$
    that makes the following diagram commute, at is it even a polynomial function
    with $M^3$ indeterminates:
    \begin{center}
        \begin{tikzcd}
            (M^3)^* 
            \arrow{dr}[below,anchor=center,rotate=-39,yshift=-3pt]{\mathsf{count}}
            & \Sigma^* \arrow{l}[above]{\mathsf{t}} \arrow{r}{f} \arrow{d}[left]{\mathsf{s}} & \Rel \\
            & \Nat^{M^3} \arrow{ur}[below]{g} & \\
        \end{tikzcd}
    \end{center}
    One problem is that the map $\mathsf{s}$ is not surjective, because of
    potential dependencies between the types encountered in $w$.
    Let us however notice that one can build a context-free grammar
    recognizing exactly the image of $\mathsf{t}$. Namely,
    \begin{align*}
        S &\to S^{1,m,1} &  m \in M \\
        S^{m_r, m, m_l} &\to (m_l, m, m_r) & \exists a \in \Sigma, \mu(a) = m \\
        S^{m_r, m, m_l} &\to 
        S^{m_r, m_x, m_y m_l}
        S^{m_r m_x, m_y, m_l}
                        & m_x m_y = m
    \end{align*}

    Using Parikh's Theorem \cite{PARI66},
    we conclude that the image of $\mathsf{s}$ is a semilinear set,
    i.e., that there exists a finite set $Q$,
    numbers $\seqof{d_q}{q \in Q}$,
    vectors $\seqof{v_{i,q}}{0 \leq i \leq d_q, q \in Q}$ in $\Nat^{M^3}$,
    such that
    \begin{equation*}
        \mathsf{s}(\Sigma^*) =
        \bigcup_{q \in Q}
        \setof{
            v_0 + \sum_{i = 1}^{d_q} \lambda_i v_{i,q}
        }{
            (\lambda_1, \dots, \lambda_{d_q}) \in \Nat^{d_q}
        } \quad .
    \end{equation*}

    We can therefore define a function $\mathsf{decode} \colon \Sigma^* \to
    \sum_{q \in Q} \Nat^{d_q}$ that maps to a word $w$ to \emph{some} $q \in Q$
    and parameters $(\lambda_1, \dots, \lambda_{d_q}) \in \Nat^{d_q}$ such that
    $\mathsf{s}(w) = v_0 + \sum_{i = 1}^{d_q} \lambda_i v_{i,q}$. By taming the
    semilinear set prior to this step, we can ensure that the function is in
    fact uniquely defined, this is done by computing an equivalent semilinear
    set that is \emph{unambiguous} and \emph{proper} \cite{CHHA16}.
    Similarly, let us define $\mathsf{encode} \colon \sum_{q \in Q} \Nat^{d_q}
    \to \Sigma^*$ that maps an element $q \in Q$ with parameters $(\lambda_1,
    \dots, \lambda_{d_q}) \in \Nat^{d_q}$ to \emph{some} word $w \in \Sigma^*$
    such that $\mathsf{s}(w) = v_0 + \sum_{i = 1}^{d_q} \lambda_i v_{i,q}$.
    Notice that $\mathsf{decode} \circ \mathsf{encode} = \mathsf{id}$, by the
    unicity of the representation in $\sum_{q \in Q} \Nat^{d_q}$.
    We can define the map $\mathsf{repr} \colon \sum_{q \in Q} \Nat^{d_q} \to \Nat^{M^3}$
    as follows:
    \begin{equation*}
        \mathsf{repr}(q, \lambda_1, \dots, \lambda_{d_q}) \defined
        v_0 + \sum_{i = 1}^{d_q} \lambda_i v_{i,q}
        \quad .
    \end{equation*}
    Finally, let us define for $q \in Q$ the map $g_q \colon \Nat^{d_q} \to \Rel$ as the polynomial
    expression:
    \begin{equation*}
        g_q(\lambda_1, \dots, \lambda_{d_q}) \defined \mathsf{repr}(q, \lambda_1, \dots, \lambda_{d_q}) \quad .
    \end{equation*}

    We have proven that the following diagram commutes:
    \begin{center}
        \begin{tikzcd}
            \Sigma^* \arrow{rr}{f} 
                     \arrow{dr}{\mathsf{s}}
                     \arrow[bend right=20]{dd}[rotate=90,anchor=center,yshift=4pt]{\mathsf{decode}}
                     &        & \Rel \\
                     & \Nat^{M^3} \arrow{ur}[below]{g} & \\
            \sum_{q \in Q} \Nat^{d_q}
            \arrow[bend right=20]{uu}[right,rotate=90,anchor=center,yshift=-4pt]{\mathsf{encode}}
            \arrow{ur}[left]{\mathsf{repr}}
            \arrow[bend right=45]{uurr}[right]{\seqof{g_q}{q \in Q}}
                     & & \\
        \end{tikzcd}
    \end{center}

    The only missing part of this proof is the fact that the maps $\mathsf{encode}$ and
    $\mathsf{decode}$ can be computed as \kl{polyregular functions}. Notice
    that \emph{mutatis mutandis}, the same proof scheme applies to $f \in
    \ZSF[k]$, by assuming that the monoid is aperiodic, since the functions
    constructed (apart from $\mathsf{encode}$ and $\mathsf{decode}$) will be
    \kl{star-free}.
\end{proofof}
