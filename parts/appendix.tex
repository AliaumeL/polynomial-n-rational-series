%! TeX program = xelatex
%! lang = en-US
\section{Proofs of
section \ref{preliminaries:sec}}


\begin{proof}[Proof of \cref{decidable-commutative-rat:lemma}]
    Because $f$ is a \kl{$\Rel$-rational series},
    there exists a $n \in \Nat$,
    vectors $v_1$ and $v_2$,
    and $n$ by $n$ integer matrices $\seqof{M_a}{a \in \Sigma}$,
    such that
    \begin{equation*}
        \forall w \in \Sigma^*,
        f(w) = {}^t v_1 \left(\prod_{i = 1}^{|w|} M_{w_i}\right) v_2 \quad .
    \end{equation*}
    To simplify notations, 
    let us write $M_w \defined \prod_{i = 1}^{|w|} M_{w_i}$,
    and 
    $S \defined \setof{M_w}{w \in \Sigma^+}$ be the
    semigroup generated by $\seqof{M_a}{a \in \Sigma}$.

    The function $f$ is \kl{commutative} if and only if for all $u,v \in
    \Sigma^+$, ${}^t v_1 (M_u M_v  - M_v M_u) v_2 = 0$. The above is a
    polynomial equation involving the coefficients of $M_u$ and $M_v$.
    Let us compute $\overline{S \times S}$ the Zariski closure of $S \times S$.
    The above polynomial vanishes over $S \times S$ if and only
    if it belongs to the Zariski closure, which is decidable
    \cite{HROUPOWO18}.
\end{proof}
    


\begin{proof}[Proof of
    \cref{pre-compose-growth-commut:lemma}]
    If $f \in \ZPoly[k]$, then 
    for every \kl{polyregular function} $g \in \Poly[\ell]$,
    $f \circ g \in \ZPoly[k+ \ell - 1]$
    \cite[]{LOPEZ23b}.

    Conversely, it was proven in \cite[Theorem III.3]{LOPEZ23b}
    that $f \in \ZPoly[k]$ if and only if
    for all $\alpha_0, \cdots, \alpha_k$,
    for all $w_1, \dots, w_k$,
    we have 
    \begin{equation}
        \label{k-pumpable:eqn}
        f\left(
            \alpha_0 \prod_{i = 1}^k w_i^{X_i} \alpha_i
        \right)
        = \bigO( (X_1 + \cdots X_k)^{k} )
        \quad .
    \end{equation}
    Or, the \kl{commutative} \kl{star-free polyregular function} 
    $h \colon \set{1, \dots, k}^* \to \Sigma^*$ that maps
    a word $u$
    to $\alpha \prod_{i = 1}^k w_i^{\card[i]{u}}$
    has \kl{growth rate} $1$.
    Hence, 
    $f \circ h \in \ZPoly[k]$, 
    and we indeed conclude that 
    \cref{k-pumpable:eqn}
    holds, i.e. that $f \in \ZPoly[k]$.
\end{proof}

\begin{proof}[Proof of
    \cref{pre-compose-sf-commut:lemma}]
    If $f \in \ZSF$, then for all $h \in \SF$,
    $f \circ h \in \ZSF$, and \emph{a fortiori}
    for \kl{commutative} functions $h$.

    Conversely, assume that $f \circ h \in \ZSF$
    for all \kl{commutative} functions $h \in \SF$.
    Using \cite[Theorem V.13]{LOPEZ23b},
    to conclude that $f \in \ZSF$,
    it suffices to prove that
    for all $\alpha_0, \cdots, \alpha_k \in \Sigma^*$,
    for all $w_1, \dots, w_k \in \Sigma^*$,
    there exists a polynomial $P \in \Rel[X_1, \dots,X_k]$
    and a constant $N_0 \in \Nat$,
    such that if $X_1, \dots, X_k \geq N_0$:
    \begin{equation}
        \label{ultimate-polynomial:eqn}
        f\left(
            \alpha_0 \prod_{i = 1}^k w_i^{X_i} \alpha_i
        \right)
        = P(X_1, \dots, X_k)
        \quad .
    \end{equation}
    Let us consider
    the \kl{commutative} \kl{star-free polyregular function}
    $h \colon \set{1, \dots, k}^* \to \Sigma^*$ that maps
    a word $u$
    to $\alpha \prod_{i = 1}^k w_i^{\card[i]{u}}$.
    We know that
    $f \circ h \in \ZSF$, hence, that 
    there exists $Q \in \Rel[X_1, \dots, X_n]$
    and $M_0 \in \Nat$,
    such that for all $X_1, \dots, X_n \geq N_0$,
    $f \circ h( \prod_{i = 1}^k \underline{i}^{X_i}) = Q(X_1, \dots, X_n)$.
    In particular,
    we can take $N_0 = M_0$, and $P = Q$ to conclude that
    \cref{ultimate-polynomial:eqn} holds, hence, that
    $f \in \ZSF$.
\end{proof}

\section{Proofs of
section \ref{polynomials:sec}}


\begin{proof}[Proof of
    \cref{n-poly-n-poly:example}]
    The polynomials of $\Nat[\vec{X}]$
    are obtained from basic functions (constant in $\Nat$,
    $X_i$ for some $1 \leq i \leq n$)
    by products and sums. Because the basic functions are
    \kl{represented} by \kl{star-free $\Nat$-polyregular} functions,
    that are closed under these operations, we conclude.
\end{proof}


\begin{proof}[Proof of
    \cref{n-poly-combinatorics:lem}
    ]

    Let $\omega$ be an idempotent power for the finite monoid $M$,
    and
    $w \defined \alpha_0 \prod_{i = 1}^p (u_i^{\omega \times X_i} \alpha_i)$.
    Let $k \in \Nat$, and $\pi \colon M^k \topartial \Nat$ be such that
    $f = \pi^\dagger$. That is, 
    $f(w)$ is the sum over all factorizations of $w$
    into $k$ words $(w_1, \dots, w_k) \in \Sigma^*$
    of the value $\pi(\mu(w_1), \dots, \mu(w_k))$.

    Let us define an equivalence relation $\equiv$ over words of
    $\Sigma^*$ as follows: two words $v_1, v_2$ are equivalent if they are
    equal when normalizing them with the rules $u_i^{\omega} u_i^{\omega} \to
    u_i^{\omega}$ for all $1 \leq i \leq p$. That is, we disregard
    repetitions of the factors $u_i^{\omega}$ in the words.
    We lift the equivalence relation $\equiv$ to $k$-tuples of
    words by pointwise application.

    Remark that if $(v_1, \dots, v_k) \equiv (w_1, \dots, w_k)$ then
    $\pi(\mu(v_1), \dots, \mu(v_k)) = \pi(\mu(w_1), \dots, \mu(w_k))$ because
    $\mu(u_i^\omega) = \mu(u_i)^\omega$ is an idempotent element of the monoid
    $M$. In particular, $f(w)$ can be computed as the sum over equivalence
    classes for $\equiv$, of the value of $\pi$ on one representative,
    which belongs to $\Nat$.

    Therefore, it suffices to prove that the number of partitions of $w$ in a
    single equivalence class for $\equiv$ is a polynomial $P(X_1, \dots, X_p)$
    with \kl{positive coefficients} for its \kl{maximal monomials}.

    Notice that to produce all elements in a given equivalence class
    means adding the factors $u_i^\omega$ where $1 \leq i \leq p$
    back to the normalized version
    of the equivalence class. For all elements in an equivalence class,
    one has to add the same amount of $u_i^\omega$ for $1 \leq i \leq p$,
    and therefore the number of possible choices
    is either constant, or 
    is a product of binomials of the form $\binom{X - l}{s}$
    which has the desired shape.
\end{proof}


\begin{proof}[Proof of 
    \cref{derivation-monomials:fact}
    ]
    Let $M \defined X_1^{k_1} \cdots X_n^{k_n}$,
    where $k_1, \dots, k_n > 0$ and $n > 0$.
    Let us compute
    \begin{align*}
        \Diff{K}{M} &= \prod_{i = 1}^n X_i^{k_i} - \prod_{i = 1}^n (X_i - K)^{k_i} \\
                    &= \sum_{p = 1}^n \frac{K}{X_p - K} \prod_{i = 1}^n (X_i - K)^{k_i} 
    \end{align*}
    Therefore, 
    the \kl{maximal monomials} of $\Diff{K}{M}$
    are precisely
    of the form $K \frac{\prod_{i = 1}^n X_i^{k_i}}{X_p}$ for some $1 \leq p \leq i$,
    which \kl{strictly divide} $M$.
    Let $T$ be a \kl{monomial} that \kl{strictly divides} $M$,
    then, $T = \prod_{i = 1}^n X_i^{t_i}$, 
    for all $1 \leq i \leq n$, $t_i \leq k_i$,
    and there exists $1 \leq p \leq n$ such that$ t_j < k_j$.
    In particular, $T$ \kl{divides}
    $K \frac{\prod_{i = 1}^n X_i^{k_i}}{X_p}$.
\end{proof}

\begin{proof}[Proof of \cref{discrete-deriv-linear:fact}]
    TODO or to skip.
\end{proof}

\begin{proof}[Proof of \cref{maxi-monomials-submodular:fact}]
\end{proof}

\begin{proof}[Proof of \cref{derivation-monomials:fact}]
\end{proof}

\begin{proof}[Proof of \cref{derivation-simplifies:lemma}]
    Let $P \in \Rel[\vec{X}]$ and
    $K \in \Nat$.
    Leveraging 
    \cref{derivation-monomials:fact,discrete-deriv-linear:fact,maxi-monomials-submodular:fact}:
    \begin{align*}
        \MaximalMonomials\left(\Diff{K}{P}\right)
        &=
        \MaximalMonomials\left(\sum_{M \in \Monomials(P)} \Diff{K}{M}\right) \\
        &\hoareleq
        \bigcup_{M \in \Monomials(P)} 
        \MaximalMonomials(\Diff{K}{M}) \\
        &\hoarele
        \MaximalMonomials(P)
        \quad .
        \qedhere
    \end{align*}
\end{proof}
\begin{proof}[Proof of \cref{derivation-stabilises-correct:lem}]
    If $P$ is constant, then $P_2 = 0$, and $\Diff{K}{P_1} = 0$,
    hence for $K = 0$, $Q \in \CorrectPoly$.
    Otherwise, let $\nu \colon \vec{X} \topartial \Nat$,
    and let us analyze the \kl{maximal monomials} $T$
    of $\restr{Q}{\nu}$.
    Because $T$ is a \kl{monomial} of $\restr{Q}{\nu}$,
    it \kl{divides} some \kl{monomial} in $Q$, and
    using \cref{derivation-monomials:fact},
    it \kl{divides} some \kl{monomial} $M$ in 
    $\Diff{K}{P_1}$.
    Now, the monomial $T$ is computed as follows:
    \begin{align*}
        T &= 
        \sum_{S \in \Monomials(Q), T \divides S}
        \restr{S}{\nu} \\
          &= 
          \sum_{S \in \Monomials(\Diff{K}{P_1}), T \divides S}
            \restr{S}{\nu}
        + 
          \sum_{S \in \Monomials(P_2), T \divides S}
            \restr{S}{\nu}
        \\
          &\geq
          \sum_{S \in \Monomials(\Diff{K}{P_1}), T \divides S}
            \restr{S}{\nu}
          - 
            \left|
          \sum_{S \in \Monomials(P_2), T \divides S}
            \restr{S}{\nu}
            \right|
    \end{align*}

\end{proof}



\begin{proof}[Proof of
    \cref{decidability-correct:lem}]
    Let $P \in \Rel[\vec{X}]$. We prove by induction on
    $\MaximalMonomials(P)$ that whether $P \in \CorrectPoly$
    is decidable.

    If $P$ is a constant polynomial, then
    $P \in \CorrectPoly$ if and only if $P = n \in \Nat$
    which is decidable.

    Otherwise, $P$ is not a constant polynomial, and let us write $P = P_1 +
    P_2$ where $P_1$ is the sum of the \kl{maximal monomials} of $P$. If $P_1
    \not \in \Nat[\vec{X}]$, then $P \not \in \CorrectPoly$, and this is
    decidable. Hence, we can assume that $P_1 \in \Nat[\vec{X}]$. Using
    \cref{derivation-stabilises-correct:lem}, there exists a computable bound
    $K$, such that if $P \in \CorrectPoly$, then t $Q \defined (\Diff{K}{P_1} +
    P_2) \in \CorrectPoly$. Leveraging, \cref{derivation-simplifies:lemma}, we
    also know that $\MaximalMonomials(Q) \hoarele \MaximalMonomials(P)$, and
    therefore that we can decide whether $Q \in \CorrectPoly$. Notice that if
    $Q \not \in \CorrectPoly$, then $P \not \in \CorrectPoly$, hence we can
    assume that $Q \in \CorrectPoly$.

    Similarly, for partial valuations
    $\nu \colon \vec{X} \topartial \set{0, \dots, K}$
    fixing at least one indeterminate, $\MaximalMonomials(\restr{P}{\nu})
    \hoarele \MaximalMonomials{P}$. 
    We can check for all these partial valuations that
    $\restr{P}{\nu} \in \CorrectPoly$ by induction hypothesis,
    and if one test is not satisfied, then $P \not \in \CorrectPoly$.

    Let us now conclude that if all the above checks answered correctly,
    then $P \in \CorrectPoly$. Let $\nu \colon \vec{X} \topartial \Nat$
    be a partial valuation. Then, 
    one of the three following cases arise:
    \begin{itemize}
        \item 
            Either,
        $\nu$ fixes \emph{some} indeterminate $X_i$ to a value $n_i < K$.
        In that case, let us define $\delta$ as the partial function that coincides
        with $\nu$ on its domain
        $\dom(\delta) = \dom(\nu) \setminus \set{ X_i }$.
        Then, $\restr{P}{\nu} = \restr{\restr{P}{X_i = n_i}}{\delta}$.
        As we previously checked that $\restr{P}{X_i = n_i} \in \CorrectPoly$,
        we conclude in particular that 
        $\restr{P}{\nu}$ has \kl{non-negative} \kl{maximal monomials}.

        \item Or, for all $X_i$ in the (potentially empty) domain of $\nu$, $\nu(X_i)
            \geq K$. In that case, let us write $\delta \defined
            \translate{-K}(\nu)$, that is the partial map $\delta \colon
            \vec{X} \topartial \Nat$ having the same domain as $\nu$, and such
            that for all $X_i \in \dom(\nu)$, $\delta(X_i) \defined \nu(X_i) -
            K$. Recall that $Q = \Diff{K}{P_1} + P_2$, and therefore that
            $\translate{K}(P) = P_1 + \translate{K}(Q)$. By linearity,
            $\restr{\translate{K}(P)}{\delta} = \restr{P_1}{\delta} +
            \restr{\translate{K}(Q)}{\delta}$, and we conclude that the
            \kl{maximal monomials} of $\restr{\translate{K}(P)}{\delta}$ are
            \kl{non-negative}.
            Since $\restr{\translate{K}(P)}{\delta} = \translate{K}{\restr{P}{\nu}}$,
            and since
            $\translate{K}$ leaves \kl{maximal monomials} invariant,
            we conclude that
            the \kl{maximal monomials} of $\restr{P}{\nu}$
            are the same as those of $\restr{\translate{K}(P)}{\delta}$,
            and are therefore \kl{non-negative}.
            \qedhere
    \end{itemize}
\end{proof}


\begin{proof}[Proof of \cref{derivation-translation:lem}]

    To prove \cref{d-t-transl:item} $\implies$ \cref{d-t-correct:item}, let us
    remark that if $P$ is \kl{non-negative} and $\translate{K}(P) \in
    \Nat[\vec{X}]$, then $\translate{K}(P) \in \CorrectPoly$ thanks to
    \cref{n-poly-n-poly:example}. Then, for every partial valuation $\nu \colon
    \vec{X} \topartial \Nat$, $\translate{K}(\restr{P}{\nu}) \in
    \Nat[\vec{X}]$, and in particular conclude that \kl{maximal monomials} of
    $\translate{K}(\restr{P}{\nu})$ are exactly the \kl{maximal monomials} of
    $\restr{P}{\nu}$ thanks to \cref{translation-maximal:fact}, and are therefore
    \kl{non-negative}.

    Conversely, the implication \cref{d-t-correct:item} $\implies$
    \cref{d-t-transl:item} is proven by induction on $\MaximalMonomials(P)$. If
    $P$ is a constant polynomial, then $P = n$ for some $n \in \Nat$, and we
    conclude that $\translate{0}(P) \in \Nat[\vec{X}]$. Otherwise, $P = P_1 +
    P_2$ where $P_1$ is the sum of the \kl{maximal monomials} of $P$. Using
    \cref{derivation-stabilises-correct:lem}, there exists a computable $K \in
    \Nat$ such that $Q \defined \Diff{K}{P_1} + \translate{K}(P_2)$ belongs to
    $\CorrectPoly$. Since, $\MaximalMonomials(Q) \hoarele
    \MaximalMonomials(P)$, we conclude by induction hypothesis that there
    exists $L \in \Nat$ such that for every partial valuation $\nu \colon
    \vec{X} \topartial \Nat$, $\translate{L}(\restr{Q}{\nu}) \in
    \Nat[\vec{X}]$. Similarly, for all partial functions $\nu \colon \vec{X}
    \topartial \set{0, \dots, K}$ fixing at least one indeterminate of $P$,
    $\MaximalMonomials(\restr{P}{\nu}) \hoarele \MaximalMonomials(P)$, hence
    there exists $L_\nu \in \Nat$ such that $\translate{L_\nu}(\restr{P}{\nu})
    \in \Nat[\vec{X}]$. Let us define $L_m$ to be the maximum of $L$, and
    $L_\nu$ where $\nu$ ranges over partial functions described above.


    Let us prove that for all partial functions $\nu \colon \vec{X} \topartial
    \Nat$, the translation $\translate{L_m + K}(\restr{P}{\nu})$ belongs to
    $\Nat[\vec{X}]$. Without loss of generality, $\nu$ fixes only
    indeterminates that appear in $P$. If $\nu$ fixes at least one
    indeterminate $X_i$ to a value $\nu(X_i) = k \leq K$, then we can write
    $\nu = \mu [X_i = k]$, where $\mu$ does not fix the value of $X_i$. By
    construction, we know that $\translate{L_i}(\restr{\restr{P}{X_i =
    k}}{\mu})$ belongs to $\Nat[\vec{X}]$, and therefore that $\translate{K +
    L_m}(\restr{P}{\nu})$ does so too. The only case left is when all the
    variables appearing in $\nu$ are greater than $K$.
    In that case, $\nu = \translate{K}(\mu)$ for some partial 
    valuation $\mu$.
    In this case,
    $\translate{K}(\restr{P}{\translate{K}(\mu)}
    = \restr{\translate{K}(P)}{\mu}$
    thanks to 
    \cref{discrete-deriv-linear:fact}.
    Remark that by definition,
    $\translate{K}(P) = P_1 + Q$,
    hence that
    $\translate{K + L_m}(P) = \translate{L_m}(P_1) + \translate{L_m}(Q)$
    belongs to $\Nat[\vec{X}]$.
    Finally,
    we conclude that $\restr{\translate{K+L_m}(P)}{\mu}$
    belongs to $\Nat[\vec{X}]$
    because
    the latter is closed under partial applications.
\end{proof}

\section{Proofs of section \ref{beyond-polynomials:sec}}




\section{Proofs of section \ref{beyond-commutative:sec}}

\begin{proof}[Proof of
    \cref{q-o-prefix-cool:fact}]
    Let us write $Q_i$ and $O_i$ for the value of the variables
    $Q$ and $O$ at step $i$ of the \texttt{while loop}.
    We prove the desired property by induction on $i$.

    For $i=0$, the property is true because
    $Q_0 = \set{\varepsilon}$ and $O_0 = \setof{a}{a \in \Sigma}$.

    For $i+1$. Either the \texttt{if} branch was taken, in which case $Q_{i+1}
    \cup O_{i+1} = (Q_i \cup O_i) \setminus \set{u}$ for some $u \in O_i$. This
    set remains \kl{downwards closed}, and elements in $O_{i+1}$ remain maximal
    elements. 

    If the \texttt{else} branch was taken, then there exists $u \in O_i$ such
    that $Q_{i+1} = Q_i \cup \set{u}$ and $O_{i+1} = O_i \setminus \set{ u }
    \cup \setof{ ua }{ a \in \Sigma}$. We conclude that $Q_{i+1} \cup O_{i+1} =
    Q_i \cup O_i \cup \setof{ ua }{a \in \Sigma}$ continues to be \kl{downwards
    closed} for $\prefleq$. Let $v \in Q_{i+1} \cup O_{i+1}$ be such that $ua
    \prefleq v$ for some $a \in \Sigma$. Then $u \prefleq v$, and $u = v$ since
    $u$ was a maximal element. As a consequence, $ua$ is a maximal element for
    all $a \in \Sigma$. Assume by contradiction that $ua$ is comparable with
    some $v \in O_{i+1}$ with $ua \neq v$, it cannot be that $ua \prefleq v$ by
    the above argument, and if $v \prefleq ua$ with $v \neq ua$, then $v
    \prefleq u$ and $u = v$, which is absurd since $v \not \in O{i+1}$.
    We have concluded that $O_{i+1}$ continues to have pairwise incomparable
    elements.
\end{proof}
\begin{proof}[Proof of \cref{wqo-implies-termination:lemma}]
    Assume towards a contradiction that
    \cref{residual:algo} does not terminate.
    Then, the \texttt{else} branch in the \texttt{while loop}
    must be taken infinitely often.
    This means that the set $Q$ of states grows arbitrarily large.

    Let us write $\seqof{Q_i}{i \in \Nat}$ for the set of states $Q$ at step
    $i$ of the execution of \cref{residual:algo}. Applying
    \cref{q-o-prefix-cool:fact}, we know that for all $i \in \Nat$, $Q_i$ is
    \kl{downwards closed} for $\prefleq$. Let us write $Q_\infty \defined
    \bigcup_{i \in \Nat} Q_i$. The set $Q_\infty$ is infinite, and is
    \kl{downwards closed} for $\prefleq$. As a consequence, it is an infinite
    tree with a finite branching (at most $\card{\Sigma}$), and has an infinite
    branch $\seqof{u_j}{j \in \Nat}$ thanks to König’s lemma.

    Let us prove that this infinite branch is a \kl{bad sequence} for the
    ordering $\resleq{f}{k}$.
    Let $j < p$, and assume by contradiction that $u_j \resleq{f}{k} u_p$. We
    know that $u_j \in Q_j$ and $u_p \in Q_p$. Then, at step $p-1$ of the
    algorithm, $u_j \in Q_{p-1}$, since $u_j \in Q_j \subseteq Q_{p-1}$.
    Because $u_j \prefleq u_p$ and $u_j \resleq{f}{k} u_p$,
    \cref{residual:algo} must take the \texttt{if} branch at step $p-1$. As a
    consequence, $u_p \not\in Q_{p}$, which is absurd.

    We have proven that the infinite branch is a \kl{bad sequence}
    for $\resleq{f}{k}$, which contradicts the assumption.
    Hence, \cref{residual:algo} must terminate.
\end{proof}


\begin{proof}[Proof of \cref{n-poly-k-implies-wqo:lemma}]
    Because $f \in \NPoly[k]$, there exists
    a tuple $\vec{x}$ of first order free variables,
    $\MSO$ formulas $\seqof{\psi_i(\vec{x})}{1 \leq i \leq n}$,
    and positive coefficients $\seqof{m_i}{1 \leq i \leq n}$,
    such that
    $f = \sum_{i = 1}^n m_i \times \vcount{\varphi_i(\vec{x})}$.

    Let $q$ be the maximal quantifier rank of formulas $\seqof{\psi_i}{1 \leq i
    \leq n}$. To a word $u \in \Sigma^*$, we associate the vector $\MSO^q(u)$
    that maps an $\MSO$-type with $\ell \leq |\vec{x}|$ free variables to the
    number of realizations of this type in $u$.

    Let $u, v \in \Sigma^*$ such that $\MSO^q(u) \leq \MSO^q(v)$, which means
    that every $\MSO$ type (of quantifier rank $q$ and with at most $n$ free
    variables) has at least as many realizations in $v$ than it has in $u$.
    Remark that by the compositionality of $\MSO$ over words (for instance, see
    the Feferman-Vaught theorem \cite{FEVAU59,MAKOW04}), for all $\MSO^q$ types
    $t(\vec{x})$, there are finitely many $\MSO^q$ types $t_l^j(\vec{y_i}),
    t_r^j(\vec{z_i})$ with $\vec{x} = \vec{y_i} \uplus \vec{z_i}$
    for $1 \leq j \leq N_0$, such that for every
    tuple $\vec{a}$ of elements in a word $uv$, $\MSO^q(\vec{a} / uv) =
    t(\vec{x})$ if and only if there exists $1 \leq j \leq N_0$,
    such that $\vec{a} = \vec{b} \uplus \vec{c}$,
    $\MSO^q(\vec{b} / u) =
    t_l^j(\vec{y_i})$, and $\MSO^q(\vec{c} / v) = t_r^j(\vec{z_i})$.
    We write $t = t_l \odot t_r$ to signify
    that $\MSO^q(\vec{bc} / uv) = t$
    if and only if $\MSO^q(\vec{b}/u) = t_l$
    and $\MSO^q(\vec{c}/v) = t_r$.

    As a consequence, if $\MSO^q(u) \leq \MSO^q(v)$, then 
    for all $w \in \Sigma^*$: 
    \begin{align*}
        & f(vw) - f(uw) \\
        &= 
        \sum_{i = 1}^n m_i
        \left[
            \vcount{\phi_i(\vec{x})} (vw) -
            \vcount{\phi_i(\vec{x})} (uw)
        \right] \\
        &= 
        \sum_{i = 1}^n
        m_i
            \sum_{\phi_i \in t(\vec{x})}
        \left[
            \vcount{t(\vec{x})}(vw)
            -
            \vcount{t(\vec{x})}(uw)
        \right] \\
        &= 
        \sum_{i = 1}^n
        m_i
        \sum_{1 \leq j \leq N_0}
        \sum_{\phi_i \in t_l^j(\vec{y}) \odot t_r^j(\vec{z})}
        \\
        &\quad\quad
        \underbrace{
        \left[
            \vcount{t_r^j(\vec{y})}(v)
            -
            \vcount{t_r^j(\vec{y})}(u)
        \right] 
    }_{ \in \Nat }
            \times 
            \vcount{t_l^j(\vec{z})}(w)
    \end{align*}

    We have proven that if $\MSO^q(u) \leq \MSO^q(v)$, then $u \resleq{f}{k}
    v$. Recall that $\Nat^p$ is a \kl{well-quasi-ordering} when endowed with
    the product ordering, and therefore that $\setof{\MSO^q(u)}{u \in
    \Sigma^*}$ is a \kl{well-quasi-ordering}.

    Let $\seqof{u_i}{i \in \Nat}$ be an infinite sequence of $\Sigma^*$.
    Without loss of generality, one can assume that for all $i \neq j$, $u_i
    \equiv_k u_j$, i.e., that the difference $\app{f}{u_i} - \app{f}{u_j}$
    belongs to $\ZPoly[k-1]$, since the latter has finite index. Thanks to the
    above remarks, there exists $i < j$ such that $\MSO^q(u_i) \leq
    \MSO^q(u_j)$. As a consequence, $g \defined \app{f}{u_j} - \app{f}{u_i} \in
    \NPoly$, and therefore $g \in \NPoly[k-1]$. We have proven that there
    exists $i < j$ such that $u_i \resleq{f}{k} u_j$.
\end{proof}
